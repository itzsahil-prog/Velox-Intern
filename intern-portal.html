<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VeloxCode Intern Portal</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

:root {
    --primary-blue: #3E86F5;
    --primary-blue-dark: #2a75f3;
    --light-bg: #F8F9FA;
    --white-bg: #FFFFFF;
    --text-dark: #212529;
    --text-muted: #6c757d;
    --border-color: #dee2e6;
    --danger: #dc3545;
    --success: #198754;
    --warning: #ffc107;
}

/* General Styles */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
    background-color: var(--light-bg);
    color: var(--text-dark);
    line-height: 1.6;
    margin: 0;
    overflow-x: hidden;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: url('data:image/svg+xml,<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg"><defs><pattern id="grid" width="60" height="60" patternUnits="userSpaceOnUse"><path d="M 60 0 L 0 0 0 60" fill="none" stroke="rgba(0,0,0,0.03)" stroke-width="1"/></pattern></defs><rect width="100%" height="100%" fill="url(%23grid)"/></svg>');
    pointer-events: none;
    z-index: 0;
    opacity: 0.5;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    position: relative;
    z-index: 1;
}

/* Header */
.header {
    background: var(--white-bg);
    backdrop-filter: blur(15px);
    padding: 15px 0;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
    position: sticky;
    top: 0;
    z-index: 1000;
    border-bottom: 1px solid var(--border-color);
}

.header-content {
    display: flex;
    justify-content: space-between;
    align-items: center;
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 20px;
}

.logo {
    display: flex;
    align-items: center;
    cursor: pointer;
    transition: transform 0.3s ease;
}

.logo:hover {
    transform: translateY(-2px);
}

/* logo image removed - styles cleaned up */

.logo h1 {
    margin: 0;
    font-size: 22px;
    font-weight: 700;
    color: var(--text-dark);
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* Auth Page */
.auth-container {
    display: flex;
    justify-content: center;
    align-items: center;
    padding: 60px 20px;
    min-height: calc(100vh - 80px);
}

.auth-box {
    background: var(--white-bg);
    padding: 50px;
    border-radius: 24px;
    box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 480px;
    border: 1px solid var(--border-color);
    animation: slideUp 0.6s ease-out;
}

@keyframes slideUp {
    from {
        opacity: 0;
        transform: translateY(30px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.auth-box h2 {
    color: var(--text-dark);
    font-size: 32px;
    margin-bottom: 30px;
    font-weight: 700;
}

.auth-tabs {
    display: flex;
    margin-bottom: 30px;
    border-bottom: 1px solid var(--border-color);
}

.auth-tab {
    flex: 1;
    padding: 15px;
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    border-bottom: 3px solid transparent;
    transition: all 0.3s ease;
    font-size: 16px;
    font-weight: 600;
}

.auth-tab.active {
    color: var(--primary-blue);
    border-bottom-color: var(--primary-blue);
}

/* Forms */
.form-group {
    margin-bottom: 25px;
}

.form-label {
    display: block;
    margin-bottom: 10px;
    color: var(--text-dark);
    font-weight: 600;
    font-size: 14px;
}

.form-input, .form-select, .form-textarea {
    width: 100%;
    padding: 14px 18px;
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 15px;
    transition: all 0.3s ease;
    background: var(--light-bg);
}

.form-input:focus, .form-select:focus, .form-textarea:focus {
    outline: none;
    border-color: var(--primary-blue);
    box-shadow: 0 0 0 4px rgba(62, 134, 245, 0.1);
    background: var(--white-bg);
}

.form-textarea {
    resize: vertical;
    min-height: 120px;
    font-family: inherit;
}

/* Buttons */
.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 15px;
    font-weight: 600;
    transition: all 0.3s ease;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    justify-content: center;
    text-decoration: none;
}

.btn:hover {
    transform: translateY(-2px);
}

.btn-primary {
    background: var(--primary-blue);
    color: var(--white-bg);
    box-shadow: 0 4px 15px rgba(62, 134, 245, 0.3);
}

.btn-primary:hover {
    background: var(--primary-blue-dark);
    box-shadow: 0 7px 20px rgba(62, 134, 245, 0.4);
}

.btn-secondary {
    background: var(--text-muted);
    color: var(--white-bg);
}

.btn-success {
    background: var(--success);
    color: var(--white-bg);
}

.btn-danger {
    background: var(--danger);
    color: var(--white-bg);
}

.btn-outline {
    background: transparent;
    border: 1px solid var(--primary-blue);
    color: var(--primary-blue);
}

.btn-outline:hover {
    background: var(--primary-blue);
    color: var(--white-bg);
}

.btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
}

.w-full {
    width: 100%;
}

/* Dashboard */
.dashboard {
    padding: 40px 0;
    animation: fadeIn 0.6s ease;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.dashboard-header {
    margin-bottom: 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 20px;
    background: var(--white-bg);
    padding: 30px;
    border-radius: 20px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border-color);
}

.dashboard-title {
    font-size: 36px;
    margin: 0;
    color: var(--text-dark);
    font-weight: 700;
}

.dashboard-subtitle {
    color: var(--text-muted);
    margin: 8px 0 0 0;
    font-size: 16px;
}

/* Stats */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 25px;
    margin-bottom: 50px;
}

.stat-card {
    background: var(--primary-blue);
    color: var(--white-bg);
    padding: 35px;
    border-radius: 20px;
    transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    position: relative;
    overflow: hidden;
    box-shadow: 0 10px 30px -15px rgba(62, 134, 245, 0.3);
}

.stat-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 20px 40px -15px rgba(62, 134, 245, 0.4);
}

.stat-icon {
    font-size: 42px;
    margin-bottom: 15px;
    opacity: 0.8;
}

.stat-value {
    font-size: 38px;
    font-weight: bold;
    margin-bottom: 8px;
}

.stat-label {
    color: rgba(255, 255, 255, 0.8);
    font-size: 15px;
    font-weight: 500;
}

/* Cards */
.cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
    gap: 30px;
}

.card {
    background: var(--white-bg);
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    border: 1px solid var(--border-color);
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 12px 35px rgba(0, 0, 0, 0.1);
    border-color: var(--primary-blue);
}

.card-header {
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
}

.card-title {
    font-size: 20px;
    font-weight: 700;
    margin: 0 0 12px 0;
    color: var(--text-dark);
}

.card-meta {
    color: var(--text-muted);
    font-size: 14px;
    margin-bottom: 6px;
}

.card-actions {
    display: flex;
    gap: 12px;
    margin-top: auto;
    padding-top: 20px;
    flex-wrap: wrap;
}

/* Badges */
.badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 13px;
    font-weight: 600;
    text-transform: capitalize;
    color: var(--white-bg);
}

.badge-open, .badge-approved {
    background: var(--success);
}

.badge-closed, .badge-rejected {
    background: var(--danger);
}

.badge-pending {
    background: var(--warning);
    color: var(--text-dark);
}

/* Modal */
.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(13, 37, 63, 0.7);
    backdrop-filter: blur(8px);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.modal.active {
    display: flex;
    animation: fadeIn 0.3s ease;
}

.modal-content {
    background: var(--white-bg);
    border-radius: 16px;
    padding: 40px;
    max-width: 600px;
    width: 95%;
    max-height: 90vh;
    overflow-y: auto;
    animation: slideUp 0.4s ease-out;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
}

.modal-content::-webkit-scrollbar {
    width: 8px;
}

.modal-content::-webkit-scrollbar-track {
    background: var(--light-bg);
    border-radius: 10px;
}

.modal-content::-webkit-scrollbar-thumb {
    background: var(--primary-blue);
    border-radius: 10px;
}

.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
    padding-bottom: 20px;
    border-bottom: 1px solid var(--border-color);
}

.modal-title {
    font-size: 26px;
    color: var(--text-dark);
    font-weight: 700;
}

.modal-close {
    background: transparent;
    border: none;
    font-size: 28px;
    cursor: pointer;
    color: var(--text-muted);
    width: 40px;
    height: 40px;
    border-radius: 50%;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
}

.modal-close:hover {
    background: var(--light-bg);
    color: var(--text-dark);
    transform: rotate(90deg);
}

.modal-actions {
    display: flex;
    gap: 15px;
    justify-content: flex-end;
    margin-top: 30px;
}

/* Tables */
.table-container {
    overflow-x: auto;
    background: var(--white-bg);
    border-radius: 16px;
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border-color);
}

table {
    width: 100%;
    border-collapse: collapse;
}

th, td {
    padding: 18px;
    text-align: left;
    border-bottom: 1px solid var(--border-color);
}

th {
    background: var(--light-bg);
    color: var(--text-dark);
    font-weight: 600;
    text-transform: uppercase;
    font-size: 13px;
    letter-spacing: 0.5px;
}

tr {
    transition: background 0.2s ease;
}

tr:hover {
    background: #F0F6FF;
}

/* Utilities */
.hidden {
    display: none !important;
}

.text-center {
    text-align: center;
}

.mt-20 {
    margin-top: 20px;
}

.mb-20 {
    margin-bottom: 20px;
}

.flex {
    display: flex;
}

.flex-between {
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.gap-10 {
    gap: 10px;
}

/* File List */
.file-item {
    background: var(--light-bg);
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.file-item:hover {
    transform: translateX(5px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
}

/* Profile Score */
.score-display {
    font-size: 56px;
    font-weight: bold;
    color: var(--text-dark);
    text-align: center;
    margin: 30px 0;
}

/* Advanced Profile Styles */
.profile-header {
    background: linear-gradient(135deg, var(--primary-blue) 0%, #667eea 100%);
    border-radius: 20px;
    padding: 40px;
    color: white;
    margin-bottom: 30px;
    box-shadow: 0 10px 40px rgba(62, 134, 245, 0.3);
    position: relative;
    overflow: hidden;
}

.profile-header::before {
    content: '';
    position: absolute;
    top: -50%;
    right: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%);
    animation: pulse 4s ease-in-out infinite;
}

@keyframes pulse {
    0%, 100% { transform: scale(1); opacity: 0.5; }
    50% { transform: scale(1.1); opacity: 0.8; }
}

.profile-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 48px;
    font-weight: bold;
    border: 4px solid rgba(255, 255, 255, 0.3);
    margin-bottom: 20px;
    backdrop-filter: blur(10px);
}

.profile-name {
    font-size: 32px;
    font-weight: 700;
    margin: 10px 0;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.profile-email {
    font-size: 16px;
    opacity: 0.9;
    margin-bottom: 20px;
}

.profile-stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 20px;
    margin-top: 30px;
}

.profile-stat-item {
    text-align: center;
    background: rgba(255, 255, 255, 0.15);
    padding: 15px;
    border-radius: 12px;
    backdrop-filter: blur(10px);
}

.profile-stat-value {
    font-size: 28px;
    font-weight: 700;
    margin-bottom: 5px;
}

.profile-stat-label {
    font-size: 13px;
    opacity: 0.9;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.profile-content {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 25px;
    margin-bottom: 30px;
}

.profile-section {
    background: var(--white-bg);
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.05);
    border: 1px solid var(--border-color);
}

.profile-section-title {
    font-size: 20px;
    font-weight: 700;
    color: var(--text-dark);
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
}

.progress-bar-container {
    background: var(--light-bg);
    border-radius: 10px;
    height: 12px;
    overflow: hidden;
    margin: 15px 0;
}

.progress-bar {
    height: 100%;
    background: linear-gradient(90deg, var(--primary-blue), #667eea);
    border-radius: 10px;
    transition: width 0.6s ease;
    position: relative;
    overflow: hidden;
}

.progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    bottom: 0;
    right: 0;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

.progress-label {
    display: flex;
    justify-content: space-between;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-dark);
}

.progress-value {
    color: var(--primary-blue);
    font-weight: 700;
}

.achievement-badge {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    background: var(--light-bg);
    padding: 10px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 600;
    color: var(--text-dark);
    margin: 5px;
    border: 2px solid var(--border-color);
    transition: all 0.3s ease;
}

.achievement-badge:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    border-color: var(--primary-blue);
}

.achievement-badge.earned {
    background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    border-color: #fda085;
    color: white;
}

.activity-timeline {
    position: relative;
    padding-left: 30px;
}

.activity-timeline::before {
    content: '';
    position: absolute;
    left: 8px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--border-color);
}

.activity-item {
    position: relative;
    padding-bottom: 25px;
    padding-left: 25px;
}

.activity-item::before {
    content: '';
    position: absolute;
    left: -22px;
    top: 5px;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--primary-blue);
    border: 3px solid var(--white-bg);
    box-shadow: 0 0 0 2px var(--primary-blue);
}

.activity-content {
    background: var(--light-bg);
    padding: 15px;
    border-radius: 10px;
    border-left: 3px solid var(--primary-blue);
}

.activity-title {
    font-weight: 600;
    color: var(--text-dark);
    margin-bottom: 5px;
}

.activity-date {
    font-size: 12px;
    color: var(--text-muted);
}

.stats-grid-profile {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 15px;
    margin-top: 20px;
}

.stat-box {
    background: linear-gradient(135deg, var(--light-bg) 0%, var(--white-bg) 100%);
    padding: 20px;
    border-radius: 12px;
    text-align: center;
    border: 1px solid var(--border-color);
    transition: all 0.3s ease;
}

.stat-box:hover {
    transform: translateY(-5px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    border-color: var(--primary-blue);
}

.stat-box-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--primary-blue);
    margin-bottom: 8px;
}

.stat-box-label {
    font-size: 13px;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.certificate-badge {
    display: inline-block;
    background: linear-gradient(135deg, #f6d365 0%, #fda085 100%);
    color: white;
    padding: 12px 20px;
    border-radius: 25px;
    font-weight: 600;
    margin: 10px 5px;
    box-shadow: 0 4px 15px rgba(253, 160, 133, 0.3);
    transition: all 0.3s ease;
}

.certificate-badge:hover {
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(253, 160, 133, 0.4);
}

/* Toast Notification */
.toast {
    position: fixed;
    bottom: 30px;
    right: 30px;
    background: var(--text-dark);
    color: var(--white-bg);
    padding: 16px 28px;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.25);
    z-index: 3000;
    display: none;
    opacity: 0;
    transition: all 0.3s ease;
    transform: translateY(20px);
    font-weight: 500;
}

.toast.active {
    display: block;
    opacity: 1;
    transform: translateY(0);
}

.toast-success {
    background: var(--success);
}

.toast-error {
    background: var(--danger);
}

.toast-warning {
    background: var(--warning);
    color: var(--text-dark);
}

/* Sidebar */
.sidebar {
    position: fixed;
    left: 0;
    top: 76px; /* Adjusted for header height */
    width: 280px;
    height: calc(100vh - 76px); /* Adjusted for header */
    background: var(--white-bg);
    backdrop-filter: blur(20px);
    border-right: 1px solid var(--border-color);
    box-shadow: 5px 0 30px rgba(0, 0, 0, 0.03);
    overflow-y: auto;
    z-index: 100;
    transition: transform 0.3s ease;
    transition: transform 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
}

.sidebar::-webkit-scrollbar {
    width: 6px;
}

.sidebar::-webkit-scrollbar-track {
    background: transparent;
}

.sidebar::-webkit-scrollbar-thumb {
    background: var(--primary-blue);
    border-radius: 10px;
}

.sidebar-nav {
    padding: 20px 0;
}

.sidebar-nav .nav-btn {
    display: block;
    width: 100%;
    text-align: left;
    padding: 16px 30px;
    background: transparent;
    border: none;
    color: var(--text-muted);
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
    font-size: 15px;
    font-weight: 500;
}

.sidebar-nav .nav-btn:hover {
    background: rgba(62, 134, 245, 0.1);
    color: var(--primary-blue);
    padding-left: 35px;
    border-left-color: var(--primary-blue);
}

.sidebar-nav .nav-btn.active {
    background: rgba(62, 134, 245, 0.15);
    color: var(--primary-blue);
    border-left-color: var(--primary-blue);
    font-weight: 600;
}

/* Adjust main container for sidebar */
body.has-sidebar #mainContainer {
    margin-left: 280px;
    transition: margin-left 0.3s ease;
    transition: margin-left 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
}

h2[style*="color: white"] {
    color: var(--text-dark) !important;
    text-shadow: none !important;
}


/* Responsive */
@media (max-width: 968px) {
    .dashboard-header {
        text-align: center;
        justify-content: center;
        flex-direction: column;
    }

    .cards-grid {
        grid-template-columns: 1fr;
    }

    .sidebar {
        width: 240px;
    }

    body.has-sidebar #mainContainer {
        margin-left: 240px;
    }

    .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    }
}

@media (max-width: 768px) {
    .sidebar {
        transform: translateX(-100%);
    }

    .sidebar.mobile-open {
        transform: translateX(0);
    }

    body.has-sidebar #mainContainer {
        margin-left: 0;
    }

    .auth-container {
        padding: 0;
    }

    .auth-box {
        padding: 35px 25px;
        box-shadow: none;
        border-radius: 0;
        border: none;
        min-height: calc(100vh - 76px);
    }

    .dashboard-title {
        font-size: 28px;
    }

    .stat-card {
        padding: 25px;
    }
}

/* Button Size Variants */
.btn-sm {
    padding: 10px 20px;
    font-size: 13px;
}

/* Loading Animation */
@keyframes spin {
    to { transform: rotate(360deg); }
}

.loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: var(--white-bg);
    animation: spin 0.8s linear infinite;
}

/* Sidebar Toggle Button (rectangular horizontal hamburger ‚Üí vertical bars on open) */
.sidebar-toggle {
    display: inline-flex;
    width: 64px;
    height: 36px;
    background: transparent;
    border: 2px solid transparent;
    font-size: 16px;
    cursor: pointer;
    color: var(--text-muted);
    padding: 0;
    border-radius: 10px;
    transition: background-color 0.22s ease, border-color 0.22s ease, transform 0.22s ease;
    align-items: center;
    justify-content: center;
    position: relative;
}
.sidebar-toggle:hover {
    background: rgba(0,0,0,0.04);
    color: var(--text-dark);
    border-color: rgba(0,0,0,0.06);
}
.sidebar-toggle .bar {
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    width: 26px;
    height: 2px;
    background: currentColor;
    border-radius: 2px;
    transition: all 0.28s cubic-bezier(.2,.8,.2,1);
}
.sidebar-toggle .bar.bar1 { top: 8px; }
.sidebar-toggle .bar.bar2 { top: 17px; }
.sidebar-toggle .bar.bar3 { top: 26px; }

/* Open: transform into three vertical bars (left, center, right) and turn blue */
.sidebar-toggle.open {
    color: #fff; /* bars will be white when background is blue */
    background: var(--primary-blue);
    border-color: var(--primary-blue);
    box-shadow: 0 6px 20px rgba(30,60,120,0.12);
}
.sidebar-toggle.open .bar {
    width: 2px;
    height: 18px;
    background: #fff;
    transform: none;
}
.sidebar-toggle.open .bar.bar1 {
    left: 18px;
    top: 50%;
    transform: translateY(-50%);
}
.sidebar-toggle.open .bar.bar2 {
    left: 50%;
    top: 50%;
    transform: translate(-50%, -50%);
}
.sidebar-toggle.open .bar.bar3 {
    left: calc(100% - 18px);
    top: 50%;
    transform: translateY(-50%);
}

/* Ensure main content shifts smoothly */
#mainContainer {
    transition: margin-left 0.3s ease;
}

/* Overlay for mobile sidebar */
.sidebar-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.45);
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.25s ease, visibility 0.25s ease;
    z-index: 90;
    pointer-events: none;
}
.sidebar-overlay.active {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
}

/* Hide text label on small screens */
@media (max-width: 480px) {
    .logo h1 { display: none; }
    .logo img { height: 36px; }
}

/* Desktop toggle behavior: hide sidebar when not active and slide in when body.has-sidebar */
@media (min-width: 769px) {
    .sidebar {
        transform: translateX(0);
    }

    /* When body doesn't have the has-sidebar class, slide sidebar out */
    body:not(.has-sidebar) .sidebar {
        transform: translateX(-100%);
    }

    /* Ensure the main container shifts only when the sidebar is active */
    body.has-sidebar #mainContainer {
        margin-left: 280px;
    }

    /* Prevent background scroll when the sidebar overlay is active */
    body.sidebar-open {
        overflow: hidden;
    }
}
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <button id="sidebarToggleBtn" class="sidebar-toggle" style="display: none;" onclick="event.preventDefault(); event.stopPropagation(); toggleSidebar()" aria-controls="sidebar" aria-expanded="false" title="Toggle menu" aria-label="Toggle sidebar">
                        <span class="bar bar1"></span>
                        <span class="bar bar2"></span>
                        <span class="bar bar3"></span>
                        <span class="sr-only">Toggle sidebar</span>
                    </button>
                    <a href="#" onclick="showPage('dashboard'); return false;" style="text-decoration: none; color: inherit;">
                        <div class="logo">
                            <h1>VeloxCodeAgency</h1>
                        </div>
                    </a>
                </div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <span id="headerUserInfo" class="muted" style="font-size: 14px;"></span>
                <button class="btn btn-outline btn-sm" onclick="logout()" id="headerLogoutBtn" style="display: none;">Logout</button>
            </div>
        </div>
    </header>

    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar" aria-hidden="true">
        <nav class="sidebar-nav" id="sidebarNav" aria-label="Main Navigation">
            <!-- Navigation will be populated by JavaScript -->
        </nav>
    </aside>

    <!-- Overlay for mobile sidebar -->
    <div id="sidebarOverlay" class="sidebar-overlay" tabindex="-1" aria-hidden="true"></div>

    <!-- Main Container -->
    <div class="container" id="mainContainer">
        <!-- Auth Page -->
        <div id="authPage" class="auth-container">
            <div class="auth-box">
                <h2 class="text-center">Welcome to VeloxCodeAgency</h2>
                
                <div class="auth-tabs">
                    <button class="auth-tab active">Login</button>
                </div>

                <!-- Login Form -->
                <form id="loginForm" onsubmit="handleLogin(event)">
                    <div class="form-group">
                        <label class="form-label">Email</label>
                        <input type="email" class="form-input" id="loginEmail" required placeholder="Enter your email">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-input" id="loginPassword" required placeholder="Enter your password">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Role</label>
                        <select class="form-select" id="loginRole" required>
                            <option value="intern">Intern</option>
                            <option value="admin">Admin</option>
                        </select>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Login</button>
                </form>

                <hr style="margin:20px 0; opacity:0.08;" />

                <!-- Internship Application Option (opens modal) -->
                <div style="margin-top: 10px; text-align: center;">
                    <h3 class="text-center">Apply for Internship</h3>
                    <p style="margin-bottom: 10px; color: var(--muted);">Click below to open the application form.</p>
                    <button type="button" class="btn btn-primary w-full" id="openApplyBtn" onclick="openApplyModal()">Apply for Internship</button>
                </div>
            </div>
        </div>

        <!-- Intern Dashboard -->
        <div id="internDashboard" class="dashboard hidden">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">My Dashboard</h1>
                    <p class="dashboard-subtitle">Track your assignments and submissions</p>
                </div>
                <button class="btn btn-primary" onclick="openSubmissionModal()">
                    ‚ûï Submit Project
                </button>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìã</div>
                    <div class="stat-value" id="totalTasks">0</div>
                    <div class="stat-label">Total Assignments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚úÖ</div>
                    <div class="stat-value" id="completedTasks">0</div>
                    <div class="stat-label">Submitted</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-value" id="pendingTasks">0</div>
                    <div class="stat-label">Pending Review</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚≠ê</div>
                    <div class="stat-value" id="avgScore">0</div>
                    <div class="stat-label">Score</div>
                </div>
            </div>

            <h2 class="mb-20">üìã Assigned Tasks</h2>
            <div id="tasksGrid" class="cards-grid">
                <!-- Tasks will be populated here -->
            </div>
        </div>

        <!-- Intern History (for current intern) -->
        <div id="internHistory" class="dashboard hidden">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">Submission History</h1>
                    <p class="dashboard-subtitle">View all your past submissions</p>
                </div>
            </div>

            <div id="historyList" class="cards-grid">
                <!-- History will be populated here -->
            </div>
        </div>

        <!-- Intern Certificate -->
        <div id="internCertificate" class="dashboard hidden">
            <div class="dashboard-header">
                <h1 class="dashboard-title">My Certificate</h1>
                <p class="dashboard-subtitle">View and download your certificate</p>
            </div>

            <div class="card">
                <div id="certificateInfo">
                    <!-- Certificate info will be populated here -->
                </div>
            </div>
        </div>

        <!-- Intern Contact Admin -->
        <div id="internContactAdmin" class="dashboard hidden">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">Contact Admin</h1>
                    <p class="dashboard-subtitle">Ask doubts, send feedback, or get help</p>
                </div>
            </div>

            <div class="card mb-20" style="padding: 30px;">
                <h3 class="card-title">üìß Contact Information</h3>
                <div style="margin-top: 20px;">
                    <p class="card-meta" style="margin-bottom: 10px;"><strong>Admin Email:</strong> <a href="mailto:veloxcodeagency@gmail.com" style="color: var(--primary-blue); text-decoration: none; font-weight: 600;">admin@veloxcode.com</a></p>
                    <p class="card-meta">You can also use the form below to send your message directly.</p>
                </div>
            </div>

            <div class="card" style="padding: 30px;">
                <h3 class="card-title">üí¨ Ask Doubt or Send Feedback</h3>
                <form id="contactAdminForm" onsubmit="handleContactAdmin(event)">
                    <div class="form-group">
                        <label class="form-label">Subject</label>
                        <input type="text" class="form-input" id="contactSubject" required placeholder="What is your question or feedback about?">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="contactType" required>
                            <option value="doubt">Ask a Doubt</option>
                            <option value="feedback">Send Feedback</option>
                            <option value="help">Need Help</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Message</label>
                        <textarea class="form-textarea" id="contactMessage" required placeholder="Describe your doubt, feedback, or question in detail..." rows="6"></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Your Email (for response)</label>
                        <input type="email" class="form-input" id="contactEmail" required placeholder="Your email address">
                    </div>
                    <div class="modal-actions" style="margin-top: 20px;">
                        <button type="submit" class="btn btn-primary">üì§ Send Message</button>
                    </div>
                </form>
            </div>

            <h2 class="mt-20 mb-20">üì¨ My Messages</h2>
            <div id="myMessagesList" class="cards-grid">
                <!-- Messages will be populated here -->
            </div>
        </div>

        <!-- Intern Profile -->
        <div id="internProfile" class="dashboard hidden">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">My Profile</h1>
                    <p class="dashboard-subtitle">Manage your account information and track your progress</p>
                </div>
                <button class="btn btn-primary" onclick="openEditProfileModal()">‚úèÔ∏è Edit Profile</button>
            </div>

            <div id="profileInfo">
                <!-- Profile info will be populated here -->
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="dashboard hidden">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">Admin Dashboard</h1>
                    <p class="dashboard-subtitle">Manage interns and assignments</p>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-value" id="totalInterns">0</div>
                    <div class="stat-label">Total Interns</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìù</div>
                    <div class="stat-value" id="totalSubmissions">0</div>
                    <div class="stat-label">Total Submissions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚è≥</div>
                    <div class="stat-value" id="pendingReviews">0</div>
                    <div class="stat-label">Pending Reviews</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìö</div>
                    <div class="stat-value" id="totalGuidelines">0</div>
                    <div class="stat-label">Guidelines</div>
                </div>
            </div>

            <div class="flex-between mb-20" style="background: rgba(255,255,255,0.98); padding: 25px; border-radius: 12px; flex-wrap: wrap; gap: 15px; box-shadow: 0 4px 16px rgba(0,0,0,0.08);">
                <h2 style="margin: 0; color: #1e3c72; font-weight: 700;">üë• Interns & Submissions</h2>
                <div class="flex gap-10" style="flex-wrap: wrap;">
                    <button class="btn btn-success" onclick="openAddInternModal()">‚ûï Add Intern</button>
                    <button class="btn btn-primary" onclick="openTaskModal()">‚ûï Create Assignment</button>
                    <button class="btn btn-secondary" onclick="openGuidelineModal()">üìö Upload Guideline</button>
                </div>
            </div>

            <div class="card mb-20" style="padding: 20px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">üîç Search Interns by Name</label>
                    <input type="text" class="form-input" id="searchInternNameDashboard" placeholder="Type intern name to search..." oninput="filterInternsTableDashboard()">
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Intern Name</th>
                            <th>Email</th>
                            <th>Submissions</th>
                            <th>Score</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="internsTable">
                        <!-- Interns will be populated here -->
                    </tbody>
                </table>
            </div>

            <h2 class="mt-20 mb-20">üìù All Submissions</h2>
            <div id="submissionsGrid" class="cards-grid">
                <!-- Submissions will be populated here -->
            </div>

            <h2 class="mt-20 mb-20">üìö Guidelines</h2>
            <div id="guidelinesGrid" class="cards-grid">
                <!-- Guidelines will be populated here -->
            </div>
        </div>

        <!-- Admin: Interns Management Page -->
        <div id="adminInterns" class="dashboard hidden">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">Manage Interns</h1>
                    <p class="dashboard-subtitle">Add, assign tasks, send certificates and view details</p>
                </div>
                <div>
                    <button class="btn btn-success" onclick="openAddInternModal()">‚ûï Add Intern</button>
                </div>
            </div>

            <div class="card mb-20" style="padding: 20px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">üîç Search Interns by Name</label>
                    <input type="text" class="form-input" id="searchInternName" placeholder="Type intern name to search..." oninput="filterInternsTable()">
                </div>
            </div>

            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Intern Name</th>
                            <th>Email</th>
                            <th>Submissions</th>
                            <th>Badges</th>
                            <th>Certificate</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="adminInternsTable">
                        <!-- rows -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Admin: Submissions Page -->
        <div id="adminSubmissions" class="dashboard hidden">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">All Submissions</h1>
                    <p class="dashboard-subtitle">Review, download or delete submissions</p>
                </div>
            </div>

            <div id="adminSubmissionsGrid" class="cards-grid"></div>
        </div>

        <!-- Admin: Applications Page -->
        <div id="adminApplications" class="dashboard hidden">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">Applications</h1>
                    <p class="dashboard-subtitle">Review internship applications and create accounts</p>
                </div>
                <div>
                    <button class="btn btn-outline" onclick="renderAdminApplications()">Refresh</button>
                </div>
            </div>

            <div id="applicationsList" class="cards-grid" style="min-height: 200px;">
                <!-- Applications will be populated here -->
            </div>
        </div>

        <!-- Admin: Doubts & Feedback Page -->
        <div id="adminDoubts" class="dashboard hidden">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">Doubts & Feedback</h1>
                    <p class="dashboard-subtitle">View and respond to doubts and feedback from interns</p>
                </div>
            </div>

            <div class="card mb-20" style="padding: 20px;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label class="form-label">üîç Search Doubts/Feedback</label>
                    <input type="text" class="form-input" id="searchDoubts" placeholder="Search by subject, intern name, or type..." oninput="filterDoubtsTable()">
                </div>
            </div>

            <div class="card mb-20" style="padding: 20px; background: var(--light-bg);">
                <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: center;">
                    <div>
                        <strong>Filter by Status:</strong>
                    </div>
                    <button class="btn btn-outline btn-sm" onclick="filterDoubtsByStatus('all')">All</button>
                    <button class="btn btn-outline btn-sm" onclick="filterDoubtsByStatus('pending')">‚è≥ Pending</button>
                    <button class="btn btn-outline btn-sm" onclick="filterDoubtsByStatus('answered')">‚úÖ Answered</button>
                </div>
            </div>

            <div id="doubtsGrid" class="cards-grid">
                <!-- Doubts will be populated here -->
            </div>
        </div>

        <!-- Admin: Feedbacks Page -->
        <div id="adminFeedbacks" class="dashboard hidden">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">Feedbacks</h1>
                    <p class="dashboard-subtitle">View all feedback/remarks from reviews</p>
                </div>
            </div>

            <div id="feedbacksGrid" class="cards-grid"></div>
        </div>

        <!-- Admin: Certificates Page -->
        <div id="adminCertificates" class="dashboard hidden">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">Certificates</h1>
                    <p class="dashboard-subtitle">Issue and download certificates for interns</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="openSendCertificateModal()">üéñÔ∏è Issue Certificate</button>
                </div>
            </div>

            <div id="certificatesGrid" class="cards-grid"></div>
        </div>

        <!-- Admin Profile -->
        <div id="adminProfile" class="dashboard hidden">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">Admin Profile</h1>
                    <p class="dashboard-subtitle">View intern login information and manage your account</p>
                </div>
            </div>

            <div class="card mb-20" style="padding: 30px;">
                <h3 class="card-title">üë§ Your Account Information</h3>
                <div id="adminAccountInfo" style="margin-top: 20px;">
                    <!-- Account info will be populated here -->
                </div>
            </div>

            <div class="card" style="padding: 30px;">
                <h3 class="card-title">üîê Intern Login Information</h3>
                <p class="card-meta" style="margin-bottom: 20px;">View login credentials for all interns</p>
                
                <div class="card mb-20" style="padding: 20px; background: var(--light-bg);">
                    <div class="form-group" style="margin-bottom: 0;">
                        <label class="form-label">üîç Search Interns</label>
                        <input type="text" class="form-input" id="searchInternLogin" placeholder="Search by name or email..." oninput="filterInternLoginTable()">
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Intern Name</th>
                                <th>Email</th>
                                <th>Password</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="internLoginTable">
                            <!-- Intern login info will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Admin: Intern Data History -->
        <div id="adminInternHistory" class="dashboard hidden">
            <div class="dashboard-header">
                <div>
                    <h1 class="dashboard-title">Intern Data History</h1>
                    <p class="dashboard-subtitle">Select an intern to view their submission history</p>
                </div>
                <div>
                    <select id="selectInternForHistory" class="form-select" onchange="renderSelectedInternHistory()">
                        <!-- options -->
                    </select>
                </div>
            </div>

            <div id="adminInternHistoryList" class="cards-grid"></div>
        </div>
    </div>

    <!-- Add Intern Modal (Admin) -->
    <div id="addInternModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Intern</h2>
                <button class="modal-close" onclick="closeAddInternModal()">√ó</button>
            </div>
            <form id="addInternForm" onsubmit="handleAddIntern(event)">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="addInternName" required placeholder="Enter intern's full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="addInternEmail" required placeholder="Enter intern's email">
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="text" class="form-input" id="addInternPassword" required placeholder="Enter a temporary password">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeAddInternModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Intern</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Create Account Modal (for accepting applications) -->
    <div id="createAccountModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Create Intern Account</h2>
                <button class="modal-close" onclick="closeCreateAccountModal()">√ó</button>
            </div>
            <form id="createAccountForm" onsubmit="handleCreateAccount(event)">
                <input type="hidden" id="ca_appId">
                <div class="form-group">
                    <label class="form-label">Generated Username</label>
                    <input type="text" class="form-input" id="ca_username" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="ca_fullName" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="ca_email" readonly>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="text" class="form-input" id="ca_password" required placeholder="Set a temporary password">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeCreateAccountModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Account & Send Credentials</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Apply Modal -->
    <div id="applyModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Internship Application</h2>
                <button class="modal-close" onclick="closeApplyModal()">√ó</button>
            </div>
            <form id="applyFormModal" onsubmit="handleApplicationSubmit(event)">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="appFullName" required placeholder="Your full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Personal Email</label>
                    <input type="email" class="form-input" id="appEmail" required placeholder="Your personal email">
                </div>
                <div class="form-group">
                    <label class="form-label">GitHub Profile (required)</label>
                    <input type="url" class="form-input" id="appPortfolio" required placeholder="https://github.com/your-profile">
                </div>
                <div class="form-group">
                    <label class="form-label">Phone (optional)</label>
                    <input type="text" class="form-input" id="appPhone" placeholder="Phone number">
                </div>
                <div class="form-group">
                    <label class="form-label">Message (optional)</label>
                    <textarea class="form-input" id="appMessage" placeholder="Tell us about yourself"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeApplyModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Application</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Assign Task Modal (Admin) -->
    <div id="assignTaskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Assign Task</h2>
                <button class="modal-close" onclick="closeAssignTaskModal()">√ó</button>
            </div>
            <form id="assignTaskForm" onsubmit="handleAssignTask(event)">
                <input type="hidden" id="assignTaskInternId">
                <div class="form-group">
                    <label class="form-label">Intern</label>
                    <input type="text" class="form-input" id="assignTaskInternName" disabled>
                </div>
                <div class="form-group">
                    <label class="form-label">Select Task</label>
                    <select class="form-select" id="assignTaskSelect" required>
                        <!-- Tasks will be populated here -->
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeAssignTaskModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Assign</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Submission Modal -->
    <div id="submissionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Submit Project</h2>
                <button class="modal-close" onclick="closeSubmissionModal()">√ó</button>
            </div>
            <form id="submissionForm" onsubmit="handleSubmission(event)">
                <input type="hidden" id="submissionId">
                <div class="form-group">
                    <label class="form-label">Select Task</label>
                    <select class="form-select" id="submissionTask" required>
                        <!-- Tasks will be populated here -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Project Title</label>
                    <input type="text" class="form-input" id="submissionTitle" required placeholder="Enter project title">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="submissionDescription" placeholder="Describe your project..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">GitHub Link</label>
                    <input type="url" class="form-input" id="submissionGithub" placeholder="https://github.com/...">
                </div>
                <div class="form-group">
                    <label class="form-label">Upload Files</label>
                    <input type="file" class="form-input" id="submissionFiles" multiple>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeSubmissionModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Submit Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Task Modal (Admin) -->
    <div id="taskModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add New Assignment</h2>
                <button class="modal-close" onclick="closeTaskModal()">√ó</button>
            </div>
            <form id="taskForm" onsubmit="handleAddTask(event)">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="taskTitle" required placeholder="Assignment title">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-textarea" id="taskDescription" required placeholder="Assignment description..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Deadline</label>
                    <input type="datetime-local" class="form-input" id="taskDeadline" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Max Score</label>
                    <input type="number" class="form-input" id="taskMaxScore" value="100" min="0" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeTaskModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Assignment</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Review Modal (Admin) -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Review Submission</h2>
                <button class="modal-close" onclick="closeReviewModal()">√ó</button>
            </div>
            <div id="reviewContent">
                <!-- Review content will be populated here -->
            </div>
            <form id="reviewForm" onsubmit="handleReview(event)">
                <input type="hidden" id="reviewSubmissionId">
                <div class="form-group">
                    <label class="form-label">Remarks / Feedback</label>
                    <textarea class="form-textarea" id="reviewRemarks" placeholder="Add your feedback..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Score</label>
                    <input type="number" class="form-input" id="reviewScore" min="0" placeholder="Enter score">
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-danger" onclick="handleReviewAction('rejected')">Reject</button>
                    <button type="button" class="btn btn-success" onclick="handleReviewAction('approved')">Approve</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Guideline Modal (Admin) -->
    <div id="guidelineModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Upload Guideline</h2>
                <button class="modal-close" onclick="closeGuidelineModal()">√ó</button>
            </div>
            <form id="guidelineForm" onsubmit="handleUploadGuideline(event)">
                <div class="form-group">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-input" id="guidelineTitle" required placeholder="Guideline title">
                </div>
                <div class="form-group">
                    <label class="form-label">Upload File</label>
                    <input type="file" class="form-input" id="guidelineFile" required>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeGuidelineModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>

    <!-- View Intern Profile Modal (Admin) -->
    <div id="viewInternProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Intern Profile</h2>
                <button class="modal-close" onclick="closeViewInternProfileModal()">√ó</button>
            </div>
            <div id="internProfileContent">
                <!-- Intern profile will be populated here -->
            </div>
        </div>
    </div>

    <!-- Edit Profile Modal -->
    <div id="editProfileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Edit Profile</h2>
                <button class="modal-close" onclick="closeEditProfileModal()">√ó</button>
            </div>
            <form id="editProfileForm" onsubmit="handleEditProfile(event)">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input type="text" class="form-input" id="editProfileName" required placeholder="Enter your full name">
                </div>
                <div class="form-group">
                    <label class="form-label">Email Address</label>
                    <input type="email" class="form-input" id="editProfileEmail" required placeholder="Enter your email">
                </div>
                <div class="form-group">
                    <label class="form-label">Change Password (leave blank to keep current)</label>
                    <input type="password" class="form-input" id="editProfilePassword" placeholder="Enter new password">
                </div>
                <div class="form-group">
                    <label class="form-label">Bio (Optional)</label>
                    <textarea class="form-textarea" id="editProfileBio" placeholder="Tell us about yourself..." rows="4"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeEditProfileModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Answer Doubt Modal -->
    <div id="answerDoubtModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Answer Doubt/Feedback</h2>
                <button class="modal-close" onclick="closeAnswerDoubtModal()">√ó</button>
            </div>
            <div id="doubtDetails">
                <!-- Doubt details will be populated here -->
            </div>
            <form id="answerDoubtForm" onsubmit="handleAnswerDoubt(event)">
                <input type="hidden" id="answerDoubtId">
                <div class="form-group">
                    <label class="form-label">Your Response</label>
                    <textarea class="form-textarea" id="doubtAnswer" required placeholder="Type your answer or response here..." rows="6"></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeAnswerDoubtModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Send Response</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Send Certificate Modal -->
    <div id="sendCertificateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Issue Certificate</h2>
                <button class="modal-close" onclick="closeSendCertificateModal()">√ó</button>
            </div>
            <form id="sendCertificateForm" onsubmit="handleSendCertificate(event)">
                <div class="form-group">
                    <label class="form-label">Select Intern</label>
                    <select id="certificateInternSelect" class="form-select" required>
                        <!-- interns -->
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Certificate Source</label>
                    <select id="certificateSource" class="form-select" onchange="toggleCertificateSource()" required>
                        <option value="upload">Upload Certificate File</option>
                        <option value="generate">Generate Certificate</option>
                    </select>
                </div>
                <div class="form-group" id="uploadCertificateGroup">
                    <label class="form-label">Upload Certificate File (Image: PNG, JPG, PDF)</label>
                    <input type="file" class="form-input" id="certificateFile" accept="image/png,image/jpeg,image/jpg,application/pdf">
                    <p class="card-meta" style="margin-top: 8px; font-size: 12px;">Select a certificate file from your computer to upload</p>
                </div>
                <div class="form-group" id="generateCertificateGroup" style="display: none;">
                    <label class="form-label">Message (optional)</label>
                    <textarea id="certificateMessage" class="form-textarea" placeholder="Congratulatory message or notes..."></textarea>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-outline" onclick="closeSendCertificateModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Issue Certificate</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Badge Assignment Modal -->
    <div id="badgeModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">üéñÔ∏è Manage Badges</h2>
                <button class="modal-close" onclick="closeBadgeModal()">√ó</button>
            </div>
            <div id="badgeModalContent">
                <!-- Badge selection will be populated here -->
            </div>
            <input type="hidden" id="badgeInternId">
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast">
        <span id="toastMessage"></span>
    </div>

    <script>
        /*
         * ============================================
         * VELOXCODE INTERN PORTAL - ENHANCED VERSION
         * ============================================
         * 
         * FEATURES:
         * - Super Fast Chat/Messaging System (optimized with requestAnimationFrame)
         * - Real-time Notifications (Browser + Email + WhatsApp)
         * - Header Removed (as requested)
         * 
         * NOTIFICATION SETUP:
         * 1. Email Notifications (EmailJS - Free):
         *    - Sign up at https://www.emailjs.com
         *    - Create email service (Gmail/Outlook/etc.)
         *    - Create email template
         *    - Get Service ID, Template ID, and Public Key
         *    - Update NOTIFICATION_CONFIG below
         * 
         * 2. WhatsApp Notifications:
         *    - Update adminWhatsApp in NOTIFICATION_CONFIG
         *    - Format: Country code + number (e.g., "1234567890" for +1-234-567-8900)
         *    - Notifications will open WhatsApp Web/App
         * 
         * 3. Browser Notifications:
         *    - Automatically requests permission on first use
         *    - Works in modern browsers
         * 
         * PERFORMANCE OPTIMIZATIONS:
         * - Debounced message sending
         * - requestAnimationFrame for smooth rendering
         * - DocumentFragment for batch DOM updates
         * - Throttled rendering (60fps)
         * - Efficient HTML escaping
         */
        
        // Application State
let currentUser = null;
let users = [];
let tasks = [];
let submissions = [];
let guidelines = [];
let assignments = [];
let doubts = [];
// Prospective intern applications
let applications = [];

// UI state helpers (persisted in localStorage)
function loadUIState() {
    try {
        return JSON.parse(localStorage.getItem('velox_ui') || '{}');
    } catch (e) {
        return {};
    }
}

function saveUIState(state) {
    try {
        localStorage.setItem('velox_ui', JSON.stringify(state || {}));
    } catch (e) {
        console.warn('Failed to save UI state', e);
    }
}

function applyUIState() {
    const state = loadUIState();
    const isDesktop = window.innerWidth > 768;
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const toggleBtn = document.getElementById('sidebarToggleBtn');

    if (isDesktop) {
        const openDesktop = state.sidebarOpenDesktop !== undefined ? state.sidebarOpenDesktop : true;
        document.body.classList.toggle('has-sidebar', !!openDesktop);
        if (sidebar) sidebar.setAttribute('aria-hidden', openDesktop ? 'false' : 'true');
        if (toggleBtn) {
            // Show toggle only for logged-in users
            if (currentUser) {
                toggleBtn.classList.toggle('open', !!openDesktop);
                toggleBtn.classList.toggle('active', !!openDesktop);
                toggleBtn.setAttribute('aria-expanded', !!openDesktop ? 'true' : 'false');
                if (toggleBtn.style.display === 'none') toggleBtn.style.display = 'inline-flex';
                toggleBtn.setAttribute('aria-hidden', 'false');
            } else {
                toggleBtn.style.display = 'none';
                toggleBtn.setAttribute('aria-hidden', 'true');
            }
        }
        if (overlay) {
            overlay.classList.remove('active');
            overlay.setAttribute('aria-hidden', 'true');
        }
    } else {
        // mobile
        const openMobile = !!state.sidebarOpenMobile;
        if (openMobile) {
            sidebar && sidebar.classList.add('mobile-open');
            overlay && overlay.classList.add('active');
            overlay && overlay.setAttribute('aria-hidden', 'false');
            document.body.classList.add('sidebar-open');
            if (toggleBtn) {
                toggleBtn.classList.add('open');
                toggleBtn.classList.add('active');
                toggleBtn.setAttribute('aria-expanded', 'true');
            }
        } else {
            sidebar && sidebar.classList.remove('mobile-open');
            overlay && overlay.classList.remove('active');
            overlay && overlay.setAttribute('aria-hidden', 'true');
            document.body.classList.remove('sidebar-open');
            if (toggleBtn) {
                toggleBtn.classList.remove('open');
                toggleBtn.classList.remove('active');
                toggleBtn.setAttribute('aria-expanded', 'false');
            }
        }
    }

    // Restore last visited page for logged-in users
    const lastPage = state.lastPage;
    if (lastPage && document.getElementById(lastPage) && currentUser) {
        showPage(lastPage);
    }
}

// Initialize App
function initApp() {
    loadData();
    seedData();
    initializeUserBadges(); // Initialize badges for all users
    checkSession();
    updateUI();

    // Apply persisted UI state (sidebar open/closed per device and last page)
    applyUIState();
}

// Load data from localStorage
function loadData() {
    users = JSON.parse(localStorage.getItem('velox_users') || '[]');
    tasks = JSON.parse(localStorage.getItem('velox_tasks') || '[]');
    submissions = JSON.parse(localStorage.getItem('velox_submissions') || '[]');
    guidelines = JSON.parse(localStorage.getItem('velox_guidelines') || '[]');
    assignments = JSON.parse(localStorage.getItem('velox_assignments') || '[]');
    doubts = JSON.parse(localStorage.getItem('velox_doubts') || '[]');
    // Applications submitted by prospective interns
    applications = JSON.parse(localStorage.getItem('velox_applications') || '[]');
}

// Save data to localStorage
function saveData() {
    localStorage.setItem('velox_users', JSON.stringify(users));
    localStorage.setItem('velox_tasks', JSON.stringify(tasks));
    localStorage.setItem('velox_submissions', JSON.stringify(submissions));
    localStorage.setItem('velox_guidelines', JSON.stringify(guidelines));
    localStorage.setItem('velox_assignments', JSON.stringify(assignments));
    localStorage.setItem('velox_doubts', JSON.stringify(doubts));
    // Persist applications
    localStorage.setItem('velox_applications', JSON.stringify(applications || []));
}

// Seed initial data
function seedData() {
    if (users.length === 0) {
        users = [
            {
                id: generateId(),
                name: 'Sahil Admin',
                email: 'sahil@veloxcode',
                password: 'sahil123',
                role: 'admin',
                createdAt: new Date().toISOString()
            },
            {
                id: generateId(),
                name: 'Robin Admin',
                email: 'robin@veloxcode',
                password: 'robin123',
                role: 'admin',
                createdAt: new Date().toISOString()
            },
            {
                id: generateId(),
                name: 'Admin User',
                email: 'sahil@veloxcode',
                password: 'sahil123',
                role: 'admin',
                createdAt: new Date().toISOString()
            },
            {
                id: generateId(),
                name: 'Admin User',
                email: 'robin@veloxcode',
                password: 'robin123',
                role: 'admin',
                createdAt: new Date().toISOString()
            }
        ];
    }

    if (tasks.length === 0) {
        const deadline = new Date();
        deadline.setDate(deadline.getDate() + 7);
        tasks = [
            {
                id: generateId(),
                title: 'Build Landing Page',
                description: 'Create a responsive landing page using HTML, CSS, and JavaScript',
                deadline: deadline.toISOString(),
                maxScore: 100,
                createdAt: new Date().toISOString()
            }
        ];
    }
    saveData();
}

// Generate unique ID
function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

// Check session
function checkSession() {
    const session = localStorage.getItem('velox_session');
    if (session) {
        const userId = JSON.parse(session).userId;
        currentUser = users.find(u => u.id === userId);
    }
}

// Update UI based on user state
function updateUI() {
    const authPage = document.getElementById('authPage');
    const internDashboard = document.getElementById('internDashboard');
    const internHistory = document.getElementById('internHistory');
    const internCertificate = document.getElementById('internCertificate');
    const internContactAdmin = document.getElementById('internContactAdmin');
    const internProfile = document.getElementById('internProfile');
    const adminDashboard = document.getElementById('adminDashboard');
    const sidebar = document.getElementById('sidebar');
    const sidebarNav = document.getElementById('sidebarNav');

    // Hide all pages
    authPage.classList.add('hidden');
    internDashboard.classList.add('hidden');
    internHistory.classList.add('hidden');
    internCertificate.classList.add('hidden');
    internContactAdmin.classList.add('hidden');
    internProfile.classList.add('hidden');
    adminDashboard.classList.add('hidden');
    document.getElementById('adminInterns').classList.add('hidden');
    document.getElementById('adminSubmissions').classList.add('hidden');
    document.getElementById('adminDoubts').classList.add('hidden');
    document.getElementById('adminFeedbacks').classList.add('hidden');
    document.getElementById('adminCertificates').classList.add('hidden');
    document.getElementById('adminInternHistory').classList.add('hidden');
    document.getElementById('adminProfile').classList.add('hidden');

    if (!currentUser) {
        authPage.classList.remove('hidden');
        sidebar.style.display = 'none';
        document.body.classList.remove('has-sidebar');
        const headerUserInfo = document.getElementById('headerUserInfo');
        const headerLogoutBtn = document.getElementById('headerLogoutBtn');
        if (headerUserInfo) headerUserInfo.textContent = '';
        if (headerLogoutBtn) headerLogoutBtn.style.display = 'none';

        // Hide the sidebar toggle button on the login/auth page
        const toggleBtn = document.getElementById('sidebarToggleBtn');
        if (toggleBtn) {
            toggleBtn.style.display = 'none';
            toggleBtn.setAttribute('aria-hidden', 'true');
        }

        return;
    }

    // Update header with user info
    const headerUserInfo = document.getElementById('headerUserInfo');
    const headerLogoutBtn = document.getElementById('headerLogoutBtn');
    if (headerUserInfo) {
        headerUserInfo.textContent = `üë§ ${currentUser.name} (${currentUser.role})`;
    }
    if (headerLogoutBtn) {
        headerLogoutBtn.style.display = 'block';
    }

    // Show sidebar
    sidebar.style.display = 'block';
    document.body.classList.add('has-sidebar');

    // Ensure the sidebar toggle is visible only after login (intern or admin)
    const toggleBtn = document.getElementById('sidebarToggleBtn');
    if (toggleBtn) {
        toggleBtn.style.display = 'inline-flex';
        toggleBtn.setAttribute('aria-hidden', 'false');
    }

    // Update navigation
    if (currentUser.role === 'intern') {
        sidebarNav.innerHTML = `
            <button class="nav-btn active" data-page="internDashboard" onclick="showPage('internDashboard')">üìä Dashboard</button>
            <button class="nav-btn" data-page="internHistory" onclick="showPage('internHistory')">üìú History</button>
            <button class="nav-btn" data-page="internCertificate" onclick="showPage('internCertificate')">üéñÔ∏è Certificate</button>
            <button class="nav-btn" data-page="internContactAdmin" onclick="showPage('internContactAdmin')">üí¨ Contact Admin</button>
            <button class="nav-btn" data-page="internProfile" onclick="showPage('internProfile')">üë§ Profile</button>
            <button class="nav-btn" data-page="logout" onclick="logout()">üö™ Logout</button>
        `;
        showPage('internDashboard');
        renderInternDashboard();
    } else if (currentUser.role === 'admin') {
        sidebarNav.innerHTML = `
            <button class="nav-btn active" data-page="adminDashboard" onclick="showPage('adminDashboard')">üìä Dashboard</button>
            <button class="nav-btn" data-page="adminInterns" onclick="showPage('adminInterns')">üë• Interns</button>
            <button class="nav-btn" data-page="adminSubmissions" onclick="showPage('adminSubmissions')">üìù Submissions</button>
            <button class="nav-btn" data-page="adminApplications" onclick="showPage('adminApplications')">üì® Applications</button>
            <button class="nav-btn" data-page="adminDoubts" onclick="showPage('adminDoubts')">‚ùì Doubts & Feedback</button>
            <button class="nav-btn" data-page="adminFeedbacks" onclick="showPage('adminFeedbacks')">üí¨ Feedbacks</button>
            <button class="nav-btn" data-page="adminCertificates" onclick="showPage('adminCertificates')">üéñÔ∏è Certificates</button>
            <button class="nav-btn" data-page="adminInternHistory" onclick="showPage('adminInternHistory')">üìÅ Intern Data History</button>
            <button class="nav-btn" data-page="adminProfile" onclick="showPage('adminProfile')">üë§ Profile</button>
            <button class="nav-btn" data-page="logout" onclick="logout()">üö™ Logout</button>
        `;
        showPage('adminDashboard');
        renderAdminDashboard();
    }
}

// Show specific page
function showPage(pageId) {
    // Hide all dashboards/pages that follow .dashboard
    document.querySelectorAll('.dashboard').forEach(page => page.classList.add('hidden'));
    const target = document.getElementById(pageId);
    if (target) target.classList.remove('hidden');

    // Update active nav button by data-page attribute
    document.querySelectorAll('.nav-btn').forEach(btn => {
        if (btn.dataset.page === pageId) {
            btn.classList.add('active');
        } else {
            btn.classList.remove('active');
        }
    });

    // Persist last page for logged in users
    if (currentUser) {
        const ui = loadUIState(); ui.lastPage = pageId; saveUIState(ui);
    }

    // Render page-specific content
    if (pageId === 'internDashboard') renderInternDashboard();
    if (pageId === 'internHistory') renderInternHistory();
    if (pageId === 'internCertificate') renderInternCertificate();
    if (pageId === 'internContactAdmin') renderInternContactAdmin();
    if (pageId === 'internProfile') renderInternProfile();
    if (pageId === 'adminDashboard') renderAdminDashboard();
    if (pageId === 'adminInterns') renderAdminInterns();
    if (pageId === 'adminSubmissions') renderAdminSubmissions();
    if (pageId === 'adminApplications') renderAdminApplications();
    if (pageId === 'adminDoubts') renderAdminDoubts();
    if (pageId === 'adminFeedbacks') renderAdminFeedbacks();
    if (pageId === 'adminCertificates') renderAdminCertificates();
    if (pageId === 'adminInternHistory') prepareAdminInternHistory();
    if (pageId === 'adminProfile') renderAdminProfile();

    // Hide the sidebar toggle on the login/auth page and ensure sidebar is closed
    (function() {
        const toggleBtn = document.getElementById('sidebarToggleBtn');
        if (toggleBtn) {
            if (pageId === 'authPage') {
                toggleBtn.style.display = 'none';
                // also ensure the sidebar is closed when showing auth/login
                if (typeof closeSidebar === 'function') closeSidebar();
            } else {
                // Only show toggle for authenticated users
                toggleBtn.style.display = (typeof currentUser !== 'undefined' && currentUser) ? 'inline-flex' : 'none';
                toggleBtn.setAttribute('aria-hidden', (typeof currentUser !== 'undefined' && currentUser) ? 'false' : 'true');
            }
        }
    })();

    // Automatically close sidebar after a navigation selection
    // This ensures the slidebar closes on both mobile and desktop when an option is clicked
    if (typeof closeSidebar === 'function') {
        // small delay so any click handlers (like logout) run first
        setTimeout(() => closeSidebar(), 10);
    }
}

// Auth Functions
function handleLogin(event) {
    event.preventDefault();
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    const role = document.getElementById('loginRole').value;

    const user = users.find(u => u.email === email && u.password === password && u.role === role);

    if (user) {
        currentUser = user;
        localStorage.setItem('velox_session', JSON.stringify({ userId: user.id }));
        showToast('Login successful! Welcome back.', 'success');
        updateUI();
    } else {
        showToast('Invalid credentials or role ‚ùå', 'error');
    }
}

function logout() {
    currentUser = null;
    localStorage.removeItem('velox_session');
    showToast('Logged out successfully.', 'success');
    // close the sidebar when logging out
    if (typeof closeSidebar === 'function') closeSidebar();
    updateUI();
}

// Intern Dashboard
function renderInternDashboard() {
    const userAssignments = assignments.filter(a => a.internId === currentUser.id);
    const userTasks = tasks.filter(t => userAssignments.some(a => a.taskId === t.id));

    const userSubmissions = submissions.filter(s => s.userId === currentUser.id);
    const approvedSubmissions = userSubmissions.filter(s => s.status === 'approved');
    const pendingSubmissions = userSubmissions.filter(s => s.status === 'pending');
    
    const scores = approvedSubmissions.filter(s => s.score).map(s => s.score);
    const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;

    document.getElementById('totalTasks').textContent = userTasks.length;
    document.getElementById('completedTasks').textContent = userSubmissions.length;
    document.getElementById('pendingTasks').textContent = pendingSubmissions.length;
    document.getElementById('avgScore').textContent = avgScore;

    const tasksGrid = document.getElementById('tasksGrid');
    tasksGrid.innerHTML = '';

    if (userTasks.length === 0) {
        tasksGrid.innerHTML = '<div class="card"><p class="text-center">No assignments available yet.</p></div>';
        return;
    }

    userTasks.forEach(task => {
        const deadline = new Date(task.deadline);
        const now = new Date();
        const isOpen = deadline > now;
        const userSubmission = userSubmissions.find(s => s.taskId === task.id);

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="card-header">
                <div>
                    <h3 class="card-title">${task.title}</h3>
                    <p class="card-meta">üìÖ Deadline: ${deadline.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    <p class="card-meta">‚≠ê Max Score: ${task.maxScore}</p>
                </div>
                <span class="badge badge-${isOpen ? 'open' : 'closed'}">${isOpen ? 'Open' : 'Closed'}</span>
            </div>
            <p class="card-meta">${task.description}</p>
            ${userSubmission ? `
                <div class="mt-20">
                    <span class="badge badge-${userSubmission.status}">${userSubmission.status}</span>
                    ${userSubmission.score ? `<p class="card-meta mt-20">Score: ${userSubmission.score}/${task.maxScore}</p>` : ''}
                    ${userSubmission.remarks ? `<p class="card-meta">Remarks: ${userSubmission.remarks}</p>` : ''}
                </div>
            ` : ''}
            <div class="card-actions">
                ${!userSubmission && isOpen ? `
                    <button class="btn btn-primary" onclick="openSubmissionModal('${task.id}')">Submit</button>
                ` : ''}
                ${userSubmission && isOpen ? `
                    <button class="btn btn-secondary" onclick="editSubmission('${userSubmission.id}')">Edit</button>
                    <button class="btn btn-danger" onclick="deleteSubmission('${userSubmission.id}')">Delete</button>
                ` : ''}
                ${userSubmission ? `
                    <button class="btn btn-outline" onclick="viewSubmissionDetails('${userSubmission.id}')">View Details</button>
                ` : ''}
            </div>
        `;
        tasksGrid.appendChild(card);
    });
}

// Intern History
function renderInternHistory() {
    const historyList = document.getElementById('historyList');
    const userSubmissions = submissions.filter(s => s.userId === currentUser.id);

    historyList.innerHTML = '';

    if (userSubmissions.length === 0) {
        historyList.innerHTML = '<div class="card"><p class="text-center">No submissions yet.</p></div>';
        return;
    }

    userSubmissions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(submission => {
        const task = tasks.find(t => t.id === submission.taskId);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="card-header">
                <div>
                    <h3 class="card-title">${submission.title}</h3>
                    <p class="card-meta">üìù Task: ${task ? task.title : 'Unknown'}</p>
                    <p class="card-meta">üìÖ Submitted: ${new Date(submission.createdAt).toLocaleString()}</p>
                </div>
                <span class="badge badge-${submission.status}">${submission.status}</span>
            </div>
            <p class="card-meta">${submission.description || 'No description'}</p>
            ${submission.github ? `<p class="card-meta">üîó <a href="${submission.github}" target="_blank" style="color: #667eea; font-weight: 600;">GitHub Link</a></p>` : ''}
            ${submission.score ? `<p class="card-meta">‚≠ê Score: ${submission.score}/${task ? task.maxScore : 100}</p>` : ''}
            ${submission.remarks ? `<p class="card-meta">üí¨ Remarks: ${submission.remarks}</p>` : ''}
            ${submission.files && submission.files.length > 0 ? `
                <div class="file-list mt-20">
                    <p class="card-meta"><strong>üìé Files:</strong></p>
                    ${submission.files.map(file => `
                        <div class="file-item">
                            <span>${file.name}</span>
                            <button class="btn btn-outline btn-sm" onclick="downloadFile('${file.dataUrl}', '${file.name}')">Download</button>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
        `;
        historyList.appendChild(card);
    });
}

// Intern Certificate
function renderInternCertificate() {
    const certificateInfo = document.getElementById('certificateInfo');
    
    // Reload current user data to get latest certificate
    loadData();
    const session = localStorage.getItem('velox_session');
    if (session) {
        const userId = JSON.parse(session).userId;
        currentUser = users.find(u => u.id === userId);
    }
    
    if (currentUser && currentUser.certificate) {
        const fileName = currentUser.certificate.fileName || `certificate-${currentUser.name.replace(/\s+/g,'-')}.png`;
        const isImage = currentUser.certificate.dataUrl.startsWith('data:image');
        const isPDF = currentUser.certificate.dataUrl.startsWith('data:application/pdf') || fileName.toLowerCase().endsWith('.pdf');
        
        certificateInfo.innerHTML = `
            <h3 class="card-title">üéñÔ∏è Certificate of Completion</h3>
            <p class="card-meta">üìÖ Issued: ${new Date(currentUser.certificate.issuedAt).toLocaleDateString()}</p>
            ${currentUser.certificate.message ? `<p class="card-meta">üí¨ ${currentUser.certificate.message}</p>` : ''}
            <div class="card-actions" style="margin-top: 30px;">
                <button class="btn btn-primary" onclick="downloadFile('${currentUser.certificate.dataUrl}', '${fileName}')">üì• Download Certificate</button>
            </div>
            <div style="margin-top: 30px; text-align: center;">
                ${isImage ? `
                    <img src="${currentUser.certificate.dataUrl}" alt="Certificate Preview" style="max-width: 100%; border: 2px solid var(--border-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);" />
                ` : isPDF ? `
                    <div style="padding: 40px; background: var(--light-bg); border-radius: 12px; border: 2px solid var(--border-color);">
                        <div style="font-size: 64px; margin-bottom: 20px;">üìÑ</div>
                        <p class="card-meta">PDF Certificate: ${fileName}</p>
                        <p class="card-meta" style="margin-top: 10px;">Click download to view your certificate</p>
                    </div>
                ` : `
                    <div style="padding: 40px; background: var(--light-bg); border-radius: 12px; border: 2px solid var(--border-color);">
                        <div style="font-size: 64px; margin-bottom: 20px;">üìé</div>
                        <p class="card-meta">Certificate File: ${fileName}</p>
                        <p class="card-meta" style="margin-top: 10px;">Click download to view your certificate</p>
                    </div>
                `}
            </div>
        `;
    } else {
        certificateInfo.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div style="font-size: 64px; margin-bottom: 20px;">üéñÔ∏è</div>
                <h3 class="card-title">No Certificate Yet</h3>
                <p class="card-meta">Your certificate will appear here once it has been issued by an administrator.</p>
                <p class="card-meta" style="margin-top: 20px;">Please complete your assignments and wait for admin approval.</p>
            </div>
        `;
    }
}

// Intern Profile
// Optimized Chat/Messaging System - Super Fast Rendering
let renderTimeout = null;
let lastRenderTime = 0;
const RENDER_THROTTLE = 16; // ~60fps

// Fast rendering with requestAnimationFrame and throttling
function renderInternContactAdmin() {
    // Cancel pending render
    if (renderTimeout) {
        cancelAnimationFrame(renderTimeout);
    }
    
    const now = performance.now();
    if (now - lastRenderTime < RENDER_THROTTLE) {
        renderTimeout = requestAnimationFrame(() => renderInternContactAdmin());
        return;
    }
    lastRenderTime = now;
    
    // Set email field to current user's email
    const emailField = document.getElementById('contactEmail');
    if (emailField && currentUser) {
        emailField.value = currentUser.email;
    }
    
    const myMessagesList = document.getElementById('myMessagesList');
    if (!myMessagesList) return;
    
    const userDoubts = doubts.filter(d => d.userId === currentUser.id);
    
    // Use DocumentFragment for faster DOM manipulation
    const fragment = document.createDocumentFragment();
    
    if (userDoubts.length === 0) {
        const emptyDiv = document.createElement('div');
        emptyDiv.className = 'card';
        emptyDiv.innerHTML = '<p class="text-center">No messages sent yet. Use the form above to contact admin.</p>';
        fragment.appendChild(emptyDiv);
    } else {
        const sortedDoubts = userDoubts.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
        const typeLabels = {
            'doubt': '‚ùì Doubt',
            'feedback': 'üí¨ Feedback',
            'help': 'üÜò Need Help',
            'other': 'üìù Other'
        };
        
        // Batch create elements
        sortedDoubts.forEach(doubt => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <h3 class="card-title">${escapeHtml(doubt.subject)}</h3>
                        <p class="card-meta">${typeLabels[doubt.type] || doubt.type} ‚Ä¢ ${new Date(doubt.createdAt).toLocaleString()}</p>
                    </div>
                    <span class="badge badge-${doubt.status === 'answered' ? 'approved' : 'pending'}">${doubt.status === 'answered' ? 'Answered' : 'Pending'}</span>
                </div>
                <p class="card-meta" style="margin: 15px 0;"><strong>Message:</strong></p>
                <p style="color: var(--text-dark); margin-bottom: 15px; white-space: pre-wrap;">${escapeHtml(doubt.message)}</p>
                ${doubt.answer ? `
                    <div style="margin-top: 20px; padding: 15px; background: var(--light-bg); border-radius: 10px; border-left: 3px solid var(--primary-blue);">
                        <p class="card-meta" style="margin-bottom: 8px;"><strong>Admin Response:</strong></p>
                        <p style="color: var(--text-dark); white-space: pre-wrap;">${escapeHtml(doubt.answer)}</p>
                        <p class="card-meta" style="margin-top: 10px; font-size: 12px;">Answered on ${new Date(doubt.answeredAt).toLocaleString()}</p>
                    </div>
                ` : ''}
            `;
            fragment.appendChild(card);
        });
    }
    
    // Single DOM update
    myMessagesList.innerHTML = '';
    myMessagesList.appendChild(fragment);
}

// Escape HTML helper
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Debounced contact handler for fast performance
let contactDebounceTimer = null;
function handleContactAdmin(event) {
    event.preventDefault();
    
    // Clear any pending debounce
    if (contactDebounceTimer) {
        clearTimeout(contactDebounceTimer);
    }
    
    const subject = document.getElementById('contactSubject').value.trim();
    const type = document.getElementById('contactType').value;
    const message = document.getElementById('contactMessage').value.trim();
    const email = document.getElementById('contactEmail').value.trim();
    
    if (!subject || !message || !email) {
        showToast('Please fill in all required fields ‚ö†Ô∏è', 'warning');
        return;
    }
    
    const newDoubt = {
        id: generateId(),
        userId: currentUser.id,
        userName: currentUser.name,
        userEmail: email,
        subject,
        type,
        message,
        status: 'pending',
        createdAt: new Date().toISOString()
    };
    
    doubts.push(newDoubt);
    saveData();
    
    document.getElementById('contactAdminForm').reset();
    if (currentUser) {
        document.getElementById('contactEmail').value = currentUser.email;
    }
    
    // Show notification and send to email/WhatsApp
    showNotification('Message sent successfully! Admin will respond soon ‚úÖ', 'success');
    sendNotificationToEmail(email, subject, message, type);
    sendNotificationToWhatsApp(email, subject, message);
    
    // Fast render with requestAnimationFrame
    requestAnimationFrame(() => renderInternContactAdmin());
}

function renderInternProfile() {
    const profileInfo = document.getElementById('profileInfo');
    if (!profileInfo || !currentUser) return;
    
    const userSubmissions = submissions.filter(s => s.userId === currentUser.id);
    const approvedSubmissions = userSubmissions.filter(s => s.status === 'approved');
    const pendingSubmissions = userSubmissions.filter(s => s.status === 'pending');
    const rejectedSubmissions = userSubmissions.filter(s => s.status === 'rejected');
    const scores = approvedSubmissions.filter(s => s.score).map(s => s.score);
    const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;
    const maxScore = tasks.length > 0 ? Math.max(...tasks.map(t => t.maxScore)) : 100;
    const totalScore = scores.reduce((a, b) => a + b, 0);
    const completionRate = userSubmissions.length > 0 ? Math.round((approvedSubmissions.length / userSubmissions.length) * 100) : 0;
    
    // Get user assignments
    const userAssignments = assignments.filter(a => a.internId === currentUser.id);
    const assignedTasks = tasks.filter(t => userAssignments.some(a => a.taskId === t.id));
    const completedTasks = assignedTasks.filter(task => {
        const submission = userSubmissions.find(s => s.taskId === task.id && s.status === 'approved');
        return !!submission;
    });
    const taskCompletionRate = assignedTasks.length > 0 ? Math.round((completedTasks.length / assignedTasks.length) * 100) : 0;

    // Get initials for avatar
    const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
    
    // Ensure badges array exists
    if (!currentUser.badges) currentUser.badges = [];

    // Recent activity (last 5 submissions)
    const recentActivity = userSubmissions
        .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
        .slice(0, 5);

    profileInfo.innerHTML = `
        <!-- Profile Header -->
        <div class="profile-header">
            <div class="profile-avatar">${initials}</div>
            <h2 class="profile-name">${currentUser.name}</h2>
            <p class="profile-email">üìß ${currentUser.email}</p>
            ${currentUser.badges && currentUser.badges.length > 0 ? `
                <div style="margin-top: 15px; padding: 15px; background: var(--light-bg); border-radius: 10px;">
                    <h3 style="margin-bottom: 10px; font-size: 16px; color: var(--text-dark);">üéñÔ∏è My Badges</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 8px;">
                        ${renderBadges(currentUser.badges)}
                    </div>
                </div>
            ` : ''}
            <div class="profile-stats-row">
                <div class="profile-stat-item">
                    <div class="profile-stat-value">${avgScore}</div>
                    <div class="profile-stat-label">Average Score</div>
                </div>
                <div class="profile-stat-item">
                    <div class="profile-stat-value">${userSubmissions.length}</div>
                    <div class="profile-stat-label">Submissions</div>
                </div>
                <div class="profile-stat-item">
                    <div class="profile-stat-value">${approvedSubmissions.length}</div>
                    <div class="profile-stat-label">Approved</div>
                </div>
                <div class="profile-stat-item">
                    <div class="profile-stat-value">${completionRate}%</div>
                    <div class="profile-stat-label">Success Rate</div>
                </div>
            </div>
        </div>

        <!-- Profile Content Grid -->
        <div class="profile-content">
            <!-- Statistics Section -->
            <div class="profile-section">
                <h3 class="profile-section-title">üìä Performance Statistics</h3>
                <div class="stats-grid-profile">
                    <div class="stat-box">
                        <div class="stat-box-value">${userSubmissions.length}</div>
                        <div class="stat-box-label">Total Submissions</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value">${approvedSubmissions.length}</div>
                        <div class="stat-box-label">Approved</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value">${pendingSubmissions.length}</div>
                        <div class="stat-box-label">Pending</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-box-value">${rejectedSubmissions.length}</div>
                        <div class="stat-box-label">Rejected</div>
                    </div>
                </div>
                
                <div style="margin-top: 25px;">
                    <div class="progress-label">
                        <span>Overall Completion Rate</span>
                        <span class="progress-value">${completionRate}%</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${completionRate}%"></div>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <div class="progress-label">
                        <span>Task Completion</span>
                        <span class="progress-value">${completedTasks.length}/${assignedTasks.length}</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" style="width: ${taskCompletionRate}%"></div>
                    </div>
                </div>
            </div>

            <!-- Achievements Section -->
            <div class="profile-section">
                <h3 class="profile-section-title">üèÜ Achievements & Badges</h3>
                <div style="margin-bottom: 20px;">
                    ${avgScore >= 90 ? '<span class="achievement-badge earned">‚≠ê Top Performer</span>' : '<span class="achievement-badge">‚≠ê Top Performer</span>'}
                    ${approvedSubmissions.length >= 5 ? '<span class="achievement-badge earned">üéØ Consistent Contributor</span>' : '<span class="achievement-badge">üéØ Consistent Contributor</span>'}
                    ${completionRate >= 80 ? '<span class="achievement-badge earned">‚úÖ High Success Rate</span>' : '<span class="achievement-badge">‚úÖ High Success Rate</span>'}
                    ${currentUser.certificate ? '<span class="achievement-badge earned">üéñÔ∏è Certified</span>' : '<span class="achievement-badge">üéñÔ∏è Certified</span>'}
                    ${userSubmissions.length >= 10 ? '<span class="achievement-badge earned">üìö Prolific Submitter</span>' : '<span class="achievement-badge">üìö Prolific Submitter</span>'}
                </div>
                ${currentUser.certificate ? `
                    <div style="margin-top: 20px; padding: 20px; background: linear-gradient(135deg, #f6d365 0%, #fda085 100%); border-radius: 12px; text-align: center;">
                        <p style="color: white; font-weight: 600; margin-bottom: 15px;">üéñÔ∏è Certificate Issued</p>
                        <p style="color: rgba(255,255,255,0.9); font-size: 14px; margin-bottom: 15px;">Issued on ${new Date(currentUser.certificate.issuedAt).toLocaleDateString()}</p>
                        <button class="btn btn-primary" onclick="downloadFile('${currentUser.certificate.dataUrl}', 'certificate-${currentUser.name.replace(/\\s+/g,'-')}.png')" style="background: white; color: #fda085; border: none;">üì• Download Certificate</button>
                    </div>
                ` : '<p class="card-meta" style="text-align: center; padding: 20px;">Complete more assignments to earn your certificate! üéñÔ∏è</p>'}
            </div>

            <!-- Account Information -->
            <div class="profile-section">
                <h3 class="profile-section-title">üë§ Account Information</h3>
                ${currentUser.bio ? `
                    <div style="margin-bottom: 20px; padding: 15px; background: var(--light-bg); border-radius: 10px; border-left: 3px solid var(--primary-blue);">
                        <p class="card-meta" style="margin-bottom: 8px;"><strong>About Me:</strong></p>
                        <p style="color: var(--text-dark); line-height: 1.6;">${currentUser.bio}</p>
                    </div>
                ` : ''}
                <div style="margin-bottom: 15px;">
                    <p class="card-meta" style="margin-bottom: 5px;"><strong>Full Name:</strong></p>
                    <p style="font-size: 16px; color: var(--text-dark); font-weight: 600;">${currentUser.name}</p>
                </div>
                <div style="margin-bottom: 15px;">
                    <p class="card-meta" style="margin-bottom: 5px;"><strong>Email Address:</strong></p>
                    <p style="font-size: 16px; color: var(--text-dark); font-weight: 600;">${currentUser.email}</p>
                </div>
                <div style="margin-bottom: 15px;">
                    <p class="card-meta" style="margin-bottom: 5px;"><strong>Role:</strong></p>
                    <p style="font-size: 16px; color: var(--text-dark); font-weight: 600; text-transform: capitalize;">${currentUser.role}</p>
                </div>
                <div style="margin-bottom: 15px;">
                    <p class="card-meta" style="margin-bottom: 5px;"><strong>Member Since:</strong></p>
                    <p style="font-size: 16px; color: var(--text-dark); font-weight: 600;">${new Date(currentUser.createdAt).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                </div>
                <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                    <p class="card-meta" style="margin-bottom: 10px;"><strong>Total Score:</strong> <span style="color: var(--primary-blue); font-weight: 700; font-size: 18px;">${totalScore}</span></p>
                    <p class="card-meta"><strong>Average Score:</strong> <span style="color: var(--primary-blue); font-weight: 700; font-size: 18px;">${avgScore}/${maxScore}</span></p>
                </div>
            </div>

            <!-- Recent Activity -->
            <div class="profile-section">
                <h3 class="profile-section-title">üìù Recent Activity</h3>
                ${recentActivity.length > 0 ? `
                    <div class="activity-timeline">
                        ${recentActivity.map(submission => {
                            const task = tasks.find(t => t.id === submission.taskId);
                            return `
                                <div class="activity-item">
                                    <div class="activity-content">
                                        <div class="activity-title">${submission.title}</div>
                                        <p class="card-meta" style="margin: 5px 0;">Task: ${task ? task.title : 'Unknown'}</p>
                                        <div style="display: flex; align-items: center; gap: 10px; margin-top: 8px;">
                                            <span class="badge badge-${submission.status}">${submission.status}</span>
                                            ${submission.score ? `<span style="color: var(--primary-blue); font-weight: 600;">‚≠ê ${submission.score}</span>` : ''}
                                        </div>
                                        <div class="activity-date">${new Date(submission.createdAt).toLocaleString()}</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                ` : '<p class="card-meta" style="text-align: center; padding: 20px;">No recent activity</p>'}
            </div>
        </div>
    `;
}

// Edit Profile Modal Functions
function openEditProfileModal() {
    const modal = document.getElementById('editProfileModal');
    document.getElementById('editProfileName').value = currentUser.name || '';
    document.getElementById('editProfileEmail').value = currentUser.email || '';
    document.getElementById('editProfilePassword').value = '';
    document.getElementById('editProfileBio').value = currentUser.bio || '';
    modal.classList.add('active');
}

function closeEditProfileModal() {
    document.getElementById('editProfileModal').classList.remove('active');
}

function handleEditProfile(event) {
    event.preventDefault();
    const newName = document.getElementById('editProfileName').value.trim();
    const newEmail = document.getElementById('editProfileEmail').value.trim();
    const newPassword = document.getElementById('editProfilePassword').value;
    const newBio = document.getElementById('editProfileBio').value.trim();

    if (!newName || !newEmail) {
        showToast('Name and email are required ‚ö†Ô∏è', 'error');
        return;
    }

    // Check if email is already taken by another user
    const emailExists = users.find(u => u.email === newEmail && u.id !== currentUser.id);
    if (emailExists) {
        showToast('Email already in use by another account ‚ùå', 'error');
        return;
    }

    const userIndex = users.findIndex(u => u.id === currentUser.id);
    if (userIndex === -1) {
        showToast('User not found ‚ùå', 'error');
        return;
    }

    // Update user data
    users[userIndex].name = newName;
    users[userIndex].email = newEmail;
    if (newPassword && newPassword.trim()) {
        users[userIndex].password = newPassword.trim();
    }
    if (newBio) {
        users[userIndex].bio = newBio;
    } else {
        delete users[userIndex].bio;
    }

    // Update current user object
    currentUser.name = newName;
    currentUser.email = newEmail;
    if (newPassword && newPassword.trim()) {
        currentUser.password = newPassword.trim();
    }
    if (newBio) {
        currentUser.bio = newBio;
    } else {
        delete currentUser.bio;
    }

    saveData();
    closeEditProfileModal();
    renderInternProfile();
    showToast('Profile updated successfully ‚ú®', 'success');
}

// Admin Dashboard
function renderAdminDashboard() {
    const interns = users.filter(u => u.role === 'intern');
    const pendingReviews = submissions.filter(s => s.status === 'pending');

    document.getElementById('totalInterns').textContent = interns.length;
    document.getElementById('totalSubmissions').textContent = submissions.length;
    document.getElementById('pendingReviews').textContent = pendingReviews.length;
    document.getElementById('totalGuidelines').textContent = guidelines.length;

    // Render interns table
    const internsTable = document.getElementById('internsTable');
    internsTable.innerHTML = '';

    interns.forEach(intern => {
        const internSubmissions = submissions.filter(s => s.userId === intern.id);
        const scores = internSubmissions.filter(s => s.score).map(s => s.score);
        const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${intern.name}</td>
            <td>${intern.email}</td>
            <td>${internSubmissions.length}</td>
            <td>${avgScore}</td>
            <td class="flex gap-10" style="flex-wrap: wrap;">
                <button class="btn btn-primary btn-sm" onclick="openAssignTaskModal('${intern.id}')">Assign Task</button>
                <button class="btn btn-outline btn-sm" onclick="openViewInternProfileModal('${intern.id}')">View Profile</button>
                <button class="btn btn-danger btn-sm" onclick="deleteIntern('${intern.id}')">Delete</button>
            </td>
        `;
        internsTable.appendChild(row);
    });

    // Render submissions
    const submissionsGrid = document.getElementById('submissionsGrid');
    submissionsGrid.innerHTML = '';

    if (submissions.length === 0) {
        submissionsGrid.innerHTML = '<div class="card"><p class="text-center">No submissions yet.</p></div>';
    } else {
        submissions.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).forEach(submission => {
            const user = users.find(u => u.id === submission.userId);
            const task = tasks.find(t => t.id === submission.taskId);

            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="card-header">
                    <div>
                        <h3 class="card-title">${submission.title}</h3>
                        <p class="card-meta">üë§ ${user ? user.name : 'Unknown'}</p>
                        <p class="card-meta">üìù ${task ? task.title : 'Unknown'}</p>
                        <p class="card-meta">üìÖ ${new Date(submission.createdAt).toLocaleString()}</p>
                    </div>
                    <span class="badge badge-${submission.status}">${submission.status}</span>
                </div>
                <div class="card-actions">
                    <button class="btn btn-primary" onclick="openReviewModal('${submission.id}')">Review</button>
                    ${submission.files && submission.files.length > 0 ? `
                        <button class="btn btn-secondary" onclick="downloadAllFiles('${submission.id}')">Download Files</button>
                    ` : ''}
                    <button class="btn btn-danger" onclick="deleteSubmissionAdmin('${submission.id}')">Delete</button>
                </div>
            `;
            submissionsGrid.appendChild(card);
        });
    }

    // Render guidelines
    const guidelinesGrid = document.getElementById('guidelinesGrid');
    guidelinesGrid.innerHTML = '';

    if (guidelines.length === 0) {
        guidelinesGrid.innerHTML = '<div class="card"><p class="text-center">No guidelines uploaded yet.</p></div>';
    } else {
        guidelines.forEach(guideline => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <h3 class="card-title">${guideline.title}</h3>
                <p class="card-meta">üìÑ ${guideline.fileName}</p>
                <p class="card-meta">üìÖ ${new Date(guideline.createdAt).toLocaleDateString()}</p>
                <div class="card-actions">
                    <button class="btn btn-primary" onclick="downloadFile('${guideline.dataUrl}', '${guideline.fileName}')">Download</button>
                    <button class="btn btn-danger" onclick="deleteGuideline('${guideline.id}')">Delete</button>
                </div>
            `;
            guidelinesGrid.appendChild(card);
        });
    }
}

// Filter interns table in admin interns page
function filterInternsTable() {
    const searchTerm = document.getElementById('searchInternName').value.toLowerCase().trim();
    const rows = document.querySelectorAll('#adminInternsTable tr');
    rows.forEach(row => {
        const nameCell = row.querySelector('td');
        if (nameCell) {
            const name = nameCell.textContent.toLowerCase();
            row.style.display = name.includes(searchTerm) ? '' : 'none';
        }
    });
}

// Filter interns table in admin dashboard
function filterInternsTableDashboard() {
    const searchTerm = document.getElementById('searchInternNameDashboard').value.toLowerCase().trim();
    const rows = document.querySelectorAll('#internsTable tr');
    rows.forEach(row => {
        const nameCell = row.querySelector('td');
        if (nameCell) {
            const name = nameCell.textContent.toLowerCase();
            row.style.display = name.includes(searchTerm) ? '' : 'none';
        }
    });
}

// Admin: Interns management page rendering
// Badge system - Predefined badges that admins can assign
const AVAILABLE_BADGES = [
    { id: 'excellent', label: '‚≠ê Excellent', color: '#FFD700', icon: '‚≠ê' },
    { id: 'top-performer', label: 'üèÜ Top Performer', color: '#FF6B6B', icon: 'üèÜ' },
    { id: 'fast-learner', label: 'üöÄ Fast Learner', color: '#4ECDC4', icon: 'üöÄ' },
    { id: 'team-player', label: 'ü§ù Team Player', color: '#95E1D3', icon: 'ü§ù' },
    { id: 'creative', label: 'üé® Creative', color: '#F38181', icon: 'üé®' },
    { id: 'dedicated', label: 'üí™ Dedicated', color: '#AA96DA', icon: 'üí™' },
    { id: 'innovative', label: 'üí° Innovative', color: '#FCBAD3', icon: 'üí°' },
    { id: 'reliable', label: '‚úÖ Reliable', color: '#95E1D3', icon: '‚úÖ' },
    { id: 'leader', label: 'üëë Leader', color: '#FFD93D', icon: 'üëë' },
    { id: 'problem-solver', label: 'üß© Problem Solver', color: '#6BCB77', icon: 'üß©' }
];

// Initialize badges for users if not exists - Start with empty badges (no prefilled)
function initializeUserBadges() {
    users.forEach(user => {
        // Always initialize with empty array - no prefilled badges
        if (!user.badges || user.badges.length === 0) {
            user.badges = [];
        }
    });
    saveData();
}

// Render badges for display
function renderBadges(badges) {
    if (!badges || badges.length === 0) {
        return '<span class="muted" style="font-size: 12px;">No badges</span>';
    }
    return badges.map(badgeId => {
        const badge = AVAILABLE_BADGES.find(b => b.id === badgeId);
        if (!badge) return '';
        return `<span class="badge-custom" style="display: inline-block; padding: 4px 10px; margin: 2px; border-radius: 12px; background: ${badge.color}20; color: ${badge.color}; border: 1px solid ${badge.color}; font-size: 11px; font-weight: 600;">${badge.icon} ${badge.label.replace(/^[^\s]+\s/, '')}</span>`;
    }).join('');
}

// Optimized renderAdminInterns with auto-refresh on updates
function renderAdminInterns() {
    const internRows = document.getElementById('adminInternsTable');
    if (!internRows) return;
    
    const interns = users.filter(u => u.role === 'intern');
    
    // Use DocumentFragment for faster rendering
    const fragment = document.createDocumentFragment();
    
    interns.forEach(intern => {
        // Ensure badges array exists
        if (!intern.badges) intern.badges = [];
        
        const internSubmissions = submissions.filter(s => s.userId === intern.id);
        const hasCertificate = !!intern.certificate;
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><strong>${escapeHtml(intern.name)}</strong></td>
            <td>${escapeHtml(intern.email)}</td>
            <td><span class="badge badge-${internSubmissions.length > 0 ? 'approved' : 'pending'}">${internSubmissions.length}</span></td>
            <td style="max-width: 300px; word-wrap: break-word;">
                ${renderBadges(intern.badges)}
                <button class="btn btn-outline btn-sm" onclick="openBadgeModal('${intern.id}')" style="margin-left: 8px; padding: 4px 8px; font-size: 11px;">üéñÔ∏è Manage</button>
            </td>
            <td>${hasCertificate ? '<span class="badge badge-approved">Issued</span>' : '<span class="badge badge-pending">Not issued</span>'}</td>
            <td class="flex gap-10" style="flex-wrap: wrap;">
                <button class="btn btn-primary btn-sm" onclick="openAssignTaskModal('${intern.id}')">Assign Task</button>
                <button class="btn btn-outline btn-sm" onclick="openViewInternProfileModal('${intern.id}')">View</button>
                <button class="btn btn-success btn-sm" onclick="openSendCertificateModal('${intern.id}')">Send Certificate</button>
                <button class="btn btn-danger btn-sm" onclick="deleteIntern('${intern.id}')">Delete</button>
            </td>
        `;
        fragment.appendChild(tr);
    });
    
    internRows.innerHTML = '';
    internRows.appendChild(fragment);
}

// Open badge assignment modal
function openBadgeModal(internId) {
    const modal = document.getElementById('badgeModal');
    const intern = users.find(u => u.id === internId);
    
    if (!intern) {
        showNotification('Intern not found ‚ùå', 'error');
        return;
    }
    
    // Ensure badges array exists
    if (!intern.badges) intern.badges = [];
    
    const badgeContent = document.getElementById('badgeModalContent');
    badgeContent.innerHTML = `
        <h3 style="margin-bottom: 15px;">Manage Badges for ${escapeHtml(intern.name)}</h3>
        <p class="card-meta" style="margin-bottom: 20px;">Select badges to assign to this intern:</p>
        <div id="badgeSelection" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; max-height: 400px; overflow-y: auto; padding: 10px; background: var(--light-bg); border-radius: 8px;">
            ${AVAILABLE_BADGES.map(badge => {
                const isSelected = intern.badges.includes(badge.id);
                return `
                    <label style="display: flex; align-items: center; padding: 10px; background: ${isSelected ? badge.color + '20' : 'white'}; border: 2px solid ${isSelected ? badge.color : 'var(--border-color)'}; border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="checkbox" value="${badge.id}" ${isSelected ? 'checked' : ''} style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;" onchange="updateBadgeSelection()">
                        <span style="font-size: 14px; font-weight: 500; color: ${badge.color};">${badge.icon} ${badge.label}</span>
                    </label>
                `;
            }).join('')}
        </div>
        <div style="margin-top: 20px;">
            <button class="btn btn-primary" onclick="saveBadges('${internId}')">üíæ Save Badges</button>
            <button class="btn btn-outline" onclick="closeBadgeModal()">Cancel</button>
        </div>
    `;
    
    document.getElementById('badgeInternId').value = internId;
    modal.classList.add('active');
}

// Update badge selection visual feedback
function updateBadgeSelection() {
    const checkboxes = document.querySelectorAll('#badgeSelection input[type="checkbox"]');
    checkboxes.forEach(checkbox => {
        const label = checkbox.closest('label');
        const badge = AVAILABLE_BADGES.find(b => b.id === checkbox.value);
        if (checkbox.checked) {
            label.style.background = badge.color + '20';
            label.style.borderColor = badge.color;
        } else {
            label.style.background = 'white';
            label.style.borderColor = 'var(--border-color)';
        }
    });
}

// Save badges to intern
function saveBadges(internId) {
    const intern = users.find(u => u.id === internId);
    if (!intern) {
        showNotification('Intern not found ‚ùå', 'error');
        return;
    }
    
    const checkboxes = document.querySelectorAll('#badgeSelection input[type="checkbox"]:checked');
    const newBadges = Array.from(checkboxes).map(cb => cb.value);
    const oldBadges = intern.badges || [];
    
    // Check if badges changed
    const badgesChanged = JSON.stringify(oldBadges.sort()) !== JSON.stringify(newBadges.sort());
    const addedBadges = newBadges.filter(b => !oldBadges.includes(b));
    
    intern.badges = newBadges;
    
    // Update current user if viewing own profile
    if (currentUser && currentUser.id === internId) {
        currentUser.badges = intern.badges;
    }
    
    saveData();
    closeBadgeModal();
    renderAdminInterns();
    
    // Also refresh intern profile view if open
    if (currentUser && currentUser.role === 'intern' && currentUser.id === internId) {
        renderInternProfile();
    }
    
    showNotification(`Badges updated for ${intern.name} ‚úÖ`, 'success');
    
    // Send notifications to intern if badges were added
    if (badgesChanged && addedBadges.length > 0) {
        const badgeNames = addedBadges.map(badgeId => {
            const badge = AVAILABLE_BADGES.find(b => b.id === badgeId);
            return badge ? badge.label : badgeId;
        }).join(', ');
        
        const notificationMessage = `üéñÔ∏è Congratulations! You've been awarded new badge(s): ${badgeNames}`;
        const notificationSubject = 'New Badge Awarded';
        
        // Send email notification
        sendNotificationToEmail(intern.email, notificationSubject, notificationMessage, 'badge');
        
        // Send WhatsApp notification
        sendNotificationToWhatsApp(intern.email, notificationSubject, notificationMessage);
        
        // Show browser notification if intern is logged in
        if (currentUser && currentUser.id === internId) {
            showNotification(notificationMessage, 'success', true);
        }
    }
}

// Close badge modal
function closeBadgeModal() {
    document.getElementById('badgeModal').classList.remove('active');
    document.getElementById('badgeModalContent').innerHTML = '';
}

// Auto-refresh intern information when admin makes changes
function refreshInternInfo(internId) {
    // Refresh admin interns table
    renderAdminInterns();
    
    // Refresh intern profile if viewing
    const intern = users.find(u => u.id === internId);
    if (intern && currentUser && currentUser.id === internId) {
        renderInternProfile();
    }
    
    // Refresh admin dashboard if on it
    if (currentUser && currentUser.role === 'admin') {
        renderAdminDashboard();
    }
}

// Admin: Submissions page rendering
function renderAdminSubmissions() {
    const grid = document.getElementById('adminSubmissionsGrid');
    grid.innerHTML = '';
    if (submissions.length === 0) {
        grid.innerHTML = '<div class="card"><p class="text-center">No submissions yet.</p></div>';
        return;
    }
    submissions.sort((a,b)=> new Date(b.createdAt)-new Date(a.createdAt)).forEach(submission=>{
        const user = users.find(u=>u.id===submission.userId);
        const task = tasks.find(t=>t.id===submission.taskId);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="card-header">
                <div>
                    <h3 class="card-title">${submission.title}</h3>
                    <p class="card-meta">üë§ ${user ? user.name : 'Unknown'}</p>
                    <p class="card-meta">üìù ${task ? task.title : 'Unknown'}</p>
                    <p class="card-meta">üìÖ ${new Date(submission.createdAt).toLocaleDateString()}</p>
                </div>
                <span class="badge badge-${submission.status}">${submission.status}</span>
            </div>
            <p class="card-meta">${submission.description || 'No description'}</p>
            ${submission.remarks ? `<p class="card-meta">üí¨ Remarks: ${submission.remarks}</p>` : ''}
            <div class="card-actions">
                <button class="btn btn-primary" onclick="openReviewModal('${submission.id}')">Review</button>
                ${submission.files && submission.files.length>0? `<button class="btn btn-secondary" onclick="downloadAllFiles('${submission.id}')">Download Files</button>` : ''}
                <button class="btn btn-danger" onclick="deleteSubmissionAdmin('${submission.id}')">Delete</button>
            </div>
        `;
        grid.appendChild(card);
    });
}

// Admin: Doubts & Feedback page rendering
function renderAdminDoubts() {
    const grid = document.getElementById('doubtsGrid');
    grid.innerHTML = '';
    
    if (doubts.length === 0) {
        grid.innerHTML = '<div class="card"><p class="text-center">No doubts or feedback received yet.</p></div>';
        return;
    }
    
    const sortedDoubts = doubts.sort((a, b) => {
        // Show pending first, then by date
        if (a.status !== b.status) {
            return a.status === 'pending' ? -1 : 1;
        }
        return new Date(b.createdAt) - new Date(a.createdAt);
    });
    
    sortedDoubts.forEach(doubt => {
        const intern = users.find(u => u.id === doubt.userId);
        const typeLabels = {
            'doubt': '‚ùì Doubt',
            'feedback': 'üí¨ Feedback',
            'help': 'üÜò Need Help',
            'other': 'üìù Other'
        };
        
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="card-header">
                <div>
                    <h3 class="card-title">${doubt.subject}</h3>
                    <p class="card-meta">üë§ ${doubt.userName} (${doubt.userEmail})</p>
                    <p class="card-meta">${typeLabels[doubt.type] || doubt.type} ‚Ä¢ ${new Date(doubt.createdAt).toLocaleString()}</p>
                </div>
                <span class="badge badge-${doubt.status === 'answered' ? 'approved' : 'pending'}">${doubt.status === 'answered' ? 'Answered' : 'Pending'}</span>
            </div>
            <p class="card-meta" style="margin: 15px 0;"><strong>Message:</strong></p>
            <p style="color: var(--text-dark); margin-bottom: 15px; white-space: pre-wrap;">${doubt.message}</p>
            ${doubt.answer ? `
                <div style="margin-top: 20px; padding: 15px; background: var(--light-bg); border-radius: 10px; border-left: 3px solid var(--success);">
                    <p class="card-meta" style="margin-bottom: 8px;"><strong>Your Response:</strong></p>
                    <p style="color: var(--text-dark); white-space: pre-wrap;">${doubt.answer}</p>
                    <p class="card-meta" style="margin-top: 10px; font-size: 12px;">Answered on ${new Date(doubt.answeredAt).toLocaleString()}</p>
                </div>
            ` : ''}
            <div class="card-actions">
                ${doubt.status === 'pending' ? `
                    <button class="btn btn-primary" onclick="openAnswerDoubtModal('${doubt.id}')">‚úçÔ∏è Answer</button>
                ` : `
                    <button class="btn btn-outline" onclick="openAnswerDoubtModal('${doubt.id}')">‚úèÔ∏è Edit Answer</button>
                `}
                <button class="btn btn-danger btn-sm" onclick="deleteDoubt('${doubt.id}')">Delete</button>
            </div>
        `;
        grid.appendChild(card);
    });
}

// Applications: handle submission and admin review
function handleApplicationSubmit(event) {
    event.preventDefault();
    const name = (document.getElementById('appFullName').value || '').trim();
    const email = (document.getElementById('appEmail').value || '').trim();
    const phone = (document.getElementById('appPhone').value || '').trim();
    const portfolio = (document.getElementById('appPortfolio').value || '').trim();
    const message = (document.getElementById('appMessage').value || '').trim();

    if (!name || !email) {
        showToast('Please provide your full name and email', 'error');
        return;
    }

    if (!portfolio) {
        showToast('Please provide your GitHub profile URL (required)', 'error');
        return;
    }

    // Basic GitHub URL validation
    const lower = portfolio.toLowerCase();
    if (!lower.includes('github.com')) {
        showToast('Please provide a valid GitHub profile URL that contains "github.com"', 'error');
        return;
    }

    const application = {
        id: generateId(),
        fullName: name,
        email: email,
        phone: phone,
        portfolio: portfolio,
        message: message,
        status: 'pending',
        createdAt: new Date().toISOString()
    };

    applications.push(application);
    saveData();

    // Reset modal/form if present
    const form = document.getElementById('applyFormModal') || document.getElementById('applyForm');
    if (form) form.reset();

    // Close modal if open
    if (document.getElementById('applyModal')) closeApplyModal();

    showToast('Application submitted. We will review and contact you via email.', 'success');
}

function openApplyModal() {
    const modal = document.getElementById('applyModal');
    if (!modal) return;
    modal.classList.add('active');
    // Focus first input
    const input = document.getElementById('appFullName');
    if (input) input.focus();
}

function closeApplyModal() {
    const modal = document.getElementById('applyModal');
    if (!modal) return;
    modal.classList.remove('active');
}

function renderAdminApplications() {
    const list = document.getElementById('applicationsList');
    list.innerHTML = '';

    if (!applications || applications.length === 0) {
        list.innerHTML = '<div class="card"><p class="text-center">No applications yet.</p></div>';
        return;
    }

    const sorted = applications.slice().sort((a,b) => new Date(b.createdAt) - new Date(a.createdAt));
    sorted.forEach(app => {
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="card-header">
                <div>
                    <h3 class="card-title">${escapeHtml(app.fullName)}</h3>
                    <p class="card-meta">${escapeHtml(app.email)} ‚Ä¢ ${app.phone ? escapeHtml(app.phone) : ''}</p>
                    <p class="card-meta">Applied on ${new Date(app.createdAt).toLocaleString()}</p>
                </div>
                <span class="badge badge-${app.status}">${app.status}</span>
            </div>
            <p class="card-meta" style="margin: 12px 0;">${app.portfolio ? `<a href="${escapeHtml(app.portfolio)}" target="_blank" rel="noopener">Portfolio</a>` : ''}</p>
            <p style="color: var(--text-dark); white-space: pre-wrap;">${escapeHtml(app.message || '')}</p>
            <div class="card-actions">
                ${app.status === 'pending' ? `
                    <button class="btn btn-primary" onclick="openCreateAccountModal('${app.id}')">Accept</button>
                    <button class="btn btn-danger" onclick="rejectApplication('${app.id}')">Reject</button>
                ` : `
                    <button class="btn btn-outline" onclick="openCreateAccountModal('${app.id}')">View / Edit</button>
                `}
            </div>
        `;
        list.appendChild(card);
    });
}

function openCreateAccountModal(appId) {
    const app = applications.find(a => a.id === appId);
    if (!app) return;

    const username = generateUsername(app.fullName);
    document.getElementById('ca_appId').value = app.id;
    document.getElementById('ca_username').value = username;
    document.getElementById('ca_fullName').value = app.fullName;
    document.getElementById('ca_email').value = app.email;
    document.getElementById('ca_password').value = '';

    document.getElementById('createAccountModal').classList.add('active');
}

function closeCreateAccountModal() {
    document.getElementById('createAccountModal').classList.remove('active');
}

async function handleCreateAccount(event) {
    event.preventDefault();
    const appId = document.getElementById('ca_appId').value;
    const username = (document.getElementById('ca_username').value || '').trim();
    const password = (document.getElementById('ca_password').value || '').trim();
    const fullName = (document.getElementById('ca_fullName').value || '').trim();
    const email = (document.getElementById('ca_email').value || '').trim();

    if (!password) {
        showToast('Please set a temporary password for the intern', 'error');
        return;
    }

    // Create user
    const newUser = {
        id: generateId(),
        name: fullName,
        email: username, // account username is an email-like identifier
        contactEmail: email, // store applicant's personal email for contact
        password: password,
        role: 'intern',
        createdAt: new Date().toISOString()
    };
    users.push(newUser);

    // Update application status
    const app = applications.find(a => a.id === appId);
    if (app) {
        app.status = 'accepted';
        app.internId = newUser.id;
        app.acceptedAt = new Date().toISOString();
    }

    saveData();
    closeCreateAccountModal();
    renderAdminApplications();
    renderAdminInterns();

    // Send credentials email
    const subject = 'Your VeloxCode internship account credentials';
    const body = `Hello ${fullName},\n\nYour internship account has been created.\n\nUsername: ${username}\nPassword: ${password}\n\nPlease log in and change your password after the first login.\n\nBest regards,\nVeloxCode Team`;
    await sendCredentialsEmail(email, subject, body);

    showToast('Intern account created and credentials sent', 'success');
}

function rejectApplication(appId) {
    const reason = prompt('Optional: enter a brief reason for rejection (this will be sent via email):');
    const app = applications.find(a => a.id === appId);
    if (!app) return;
    app.status = 'rejected';
    app.rejectedAt = new Date().toISOString();
    app.rejectionReason = reason || '';
    saveData();
    renderAdminApplications();

    // Send rejection email
    const subject = 'Update on your VeloxCode internship application';
    const body = `Hello ${app.fullName},\n\nThank you for applying. We regret to inform you that your application was not successful at this time.\n${reason ? '\nReason: ' + reason + '\n' : ''}\nWe appreciate your interest and encourage you to apply again in the future.\n\nBest regards,\nVeloxCode Team`;
    sendCredentialsEmail(app.email, subject, body);
}

function generateUsername(fullName) {
    if (!fullName) return '';
    const base = fullName.toLowerCase().replace(/[^a-z0-9]/g, '');
    let username = `${base}@veloxcode`;
    let i = 1;
    const existing = new Set(users.map(u => u.email ? u.email.toLowerCase() : ''));
    while (existing.has(username.toLowerCase())) {
        username = `${base}${i}@veloxcode`;
        i++;
    }
    return username;
}

async function sendCredentialsEmail(toEmail, subject, body) {
    // We want the credentials email to appear as coming from veloxcodeagency@gmail.com.
    // Note: mailto: links cannot enforce the 'From' header, so we include the agency in CC and prefix the message body with a From line.
    const agencyEmail = 'veloxcodeagency@gmail.com';
    const mailBody = `From: ${agencyEmail}\n\n${body}`;

    try {
        if (typeof emailjs === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
            script.onload = () => {
                emailjs.init(NOTIFICATION_CONFIG.emailjsPublicKey);
                // Try to send using configured template and include agency as from_email for templates
                try {
                    emailjs.send(NOTIFICATION_CONFIG.emailjsServiceId, NOTIFICATION_CONFIG.emailjsTemplateId, { to_email: toEmail, subject, message: body, from_email: agencyEmail });
                } catch (e) {
                    // Fallback to mailto with CC to agency and body prefixed with From
                    const mailtoLink = `mailto:${encodeURIComponent(toEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(mailBody)}&cc=${encodeURIComponent(agencyEmail)}`;
                    window.open(mailtoLink);
                }
            };
            document.head.appendChild(script);
            return;
        }

        await emailjs.send(NOTIFICATION_CONFIG.emailjsServiceId, NOTIFICATION_CONFIG.emailjsTemplateId, { to_email: toEmail, subject, message: body, from_email: agencyEmail });
    } catch (err) {
        console.error('Failed to send email via EmailJS', err);
        // Fallback to mailto with CC so the agency address receives a copy and the body starts with From
        const mailtoLink = `mailto:${encodeURIComponent(toEmail)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(mailBody)}&cc=${encodeURIComponent(agencyEmail)}`;
        window.open(mailtoLink);
    }
}

// Filter doubts by search
function filterDoubtsTable() {
    const searchTerm = document.getElementById('searchDoubts').value.toLowerCase().trim();
    const cards = document.querySelectorAll('#doubtsGrid .card');
    
    cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        card.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

// Filter doubts by status
let currentStatusFilter = 'all';
function filterDoubtsByStatus(status) {
    currentStatusFilter = status;
    const cards = document.querySelectorAll('#doubtsGrid .card');
    
    cards.forEach(card => {
        if (status === 'all') {
            card.style.display = '';
        } else {
            const badge = card.querySelector('.badge');
            const isPending = badge && badge.textContent.includes('Pending');
            const isAnswered = badge && badge.textContent.includes('Answered');
            
            if (status === 'pending' && isPending) {
                card.style.display = '';
            } else if (status === 'answered' && isAnswered) {
                card.style.display = '';
            } else {
                card.style.display = 'none';
            }
        }
    });
    
    // Update button styles
    document.querySelectorAll('[onclick^="filterDoubtsByStatus"]').forEach(btn => {
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-outline');
    });
    event.target.classList.remove('btn-outline');
    event.target.classList.add('btn-primary');
}

// Delete doubt
function deleteDoubt(doubtId) {
    if (confirm('Are you sure you want to delete this doubt/feedback?')) {
        doubts = doubts.filter(d => d.id !== doubtId);
        saveData();
        showToast('Doubt/feedback deleted üóëÔ∏è', 'success');
        renderAdminDoubts();
    }
}

// Answer Doubt Modal Functions
function openAnswerDoubtModal(doubtId) {
    const modal = document.getElementById('answerDoubtModal');
    const doubt = doubts.find(d => d.id === doubtId);
    
    if (!doubt) {
        showToast('Doubt not found ‚ùå', 'error');
        return;
    }
    
    const typeLabels = {
        'doubt': '‚ùì Doubt',
        'feedback': 'üí¨ Feedback',
        'help': 'üÜò Need Help',
        'other': 'üìù Other'
    };
    
    document.getElementById('answerDoubtId').value = doubtId;
    document.getElementById('doubtAnswer').value = doubt.answer || '';
    
    const doubtDetails = document.getElementById('doubtDetails');
    doubtDetails.innerHTML = `
        <div style="margin-bottom: 20px; padding: 20px; background: var(--light-bg); border-radius: 10px;">
            <h3 style="margin-bottom: 10px; color: var(--text-dark);">${doubt.subject}</h3>
            <p class="card-meta" style="margin-bottom: 8px;"><strong>From:</strong> ${doubt.userName} (${doubt.userEmail})</p>
            <p class="card-meta" style="margin-bottom: 8px;"><strong>Type:</strong> ${typeLabels[doubt.type] || doubt.type}</p>
            <p class="card-meta" style="margin-bottom: 15px;"><strong>Date:</strong> ${new Date(doubt.createdAt).toLocaleString()}</p>
            <p style="color: var(--text-dark); white-space: pre-wrap; padding: 15px; background: white; border-radius: 8px; border-left: 3px solid var(--primary-blue);">${doubt.message}</p>
        </div>
    `;
    
    modal.classList.add('active');
}

function closeAnswerDoubtModal() {
    document.getElementById('answerDoubtModal').classList.remove('active');
    document.getElementById('answerDoubtForm').reset();
}

function handleAnswerDoubt(event) {
    event.preventDefault();
    const doubtId = document.getElementById('answerDoubtId').value;
    const answer = document.getElementById('doubtAnswer').value.trim();
    
    if (!answer) {
        showNotification('Please provide an answer ‚ö†Ô∏è', 'warning');
        return;
    }
    
    const doubtIndex = doubts.findIndex(d => d.id === doubtId);
    if (doubtIndex === -1) {
        showNotification('Doubt not found ‚ùå', 'error');
        return;
    }
    
    const doubt = doubts[doubtIndex];
    doubt.answer = answer;
    doubt.status = 'answered';
    doubt.answeredAt = new Date().toISOString();
    doubt.answeredBy = currentUser.name;
    
    saveData();
    closeAnswerDoubtModal();
    
    // Send notifications to intern via email and WhatsApp
    sendNotificationToEmail(doubt.userEmail, `Re: ${doubt.subject}`, answer, 'response');
    sendNotificationToWhatsApp(doubt.userEmail, `Re: ${doubt.subject}`, answer);
    
    // Fast render
    requestAnimationFrame(() => renderAdminDoubts());
    showNotification('Response sent successfully ‚úÖ Notifications sent to intern', 'success');
}

// Admin: Feedbacks page rendering (submissions that have remarks)
function renderAdminFeedbacks() {
    const grid = document.getElementById('feedbacksGrid');
    grid.innerHTML = '';
    const feedbacks = submissions.filter(s => s.remarks && s.remarks.trim().length > 0);
    if (feedbacks.length === 0) {
        grid.innerHTML = '<div class="card"><p class="text-center">No feedback entries yet.</p></div>';
        return;
    }
    feedbacks.sort((a,b)=> new Date(b.reviewedAt || b.createdAt) - new Date(a.reviewedAt || a.createdAt)).forEach(f=>{
        const intern = users.find(u=>u.id===f.userId);
        const task = tasks.find(t=>t.id===f.taskId);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="card-header">
                <div>
                    <h3 class="card-title">${f.title}</h3>
                    <p class="card-meta">üë§ ${intern ? intern.name : 'Unknown'}</p>
                    <p class="card-meta">üìù ${task ? task.title : 'Unknown'}</p>
                    <p class="card-meta">üìÖ Reviewed: ${f.reviewedAt ? new Date(f.reviewedAt).toLocaleString() : 'N/A'}</p>
                </div>
                <span class="badge badge-${f.status}">${f.status}</span>
            </div>
            <p class="card-meta">üí¨ ${f.remarks}</p>
            ${f.score ? `<p class="card-meta">‚≠ê ${f.score}/${(task?task.maxScore:100)}</p>` : ''}
            <div class="card-actions">
                <button class="btn btn-outline" onclick="openViewInternProfileModal('${f.userId}')">View Intern</button>
                <button class="btn btn-primary" onclick="openReviewModal('${f.id}')">Edit Review</button>
            </div>
        `;
        grid.appendChild(card);
    });
}

// Admin: Certificates page rendering
function renderAdminCertificates() {
    const grid = document.getElementById('certificatesGrid');
    grid.innerHTML = '';
    const interns = users.filter(u=>u.role==='intern');
    if (interns.length===0) {
        grid.innerHTML = '<div class="card"><p class="text-center">No interns available.</p></div>';
        return;
    }
    interns.forEach(intern=>{
        const card = document.createElement('div');
        card.className = 'card';
        const fileName = intern.certificate && intern.certificate.fileName ? intern.certificate.fileName : `certificate-${intern.name.replace(/\s+/g,'-')}.png`;
        card.innerHTML = `
            <h3 class="card-title">${intern.name}</h3>
            <p class="card-meta">üìß ${intern.email}</p>
            <p class="card-meta">üìÖ Joined: ${new Date(intern.createdAt).toLocaleDateString()}</p>
            <div class="card-actions">
                <button class="btn btn-primary" onclick="openSendCertificateModal('${intern.id}')">Issue Certificate</button>
                ${intern.certificate? `<button class="btn btn-success" onclick="downloadFile('${intern.certificate.dataUrl}','${fileName}')">Download</button>` : ''}
            </div>
        `;
        grid.appendChild(card);
    });
}

// Admin: Profile page rendering with intern login information
function renderAdminProfile() {
    // Update admin account info
    const accountInfo = document.getElementById('adminAccountInfo');
    if (currentUser) {
        accountInfo.innerHTML = `
            <p class="card-meta" style="margin-bottom: 10px;"><strong>Name:</strong> ${currentUser.name}</p>
            <p class="card-meta" style="margin-bottom: 10px;"><strong>Email:</strong> ${currentUser.email}</p>
            <p class="card-meta" style="margin-bottom: 10px;"><strong>Role:</strong> ${currentUser.role}</p>
            <p class="card-meta"><strong>Member Since:</strong> ${new Date(currentUser.createdAt).toLocaleDateString()}</p>
        `;
    }
    
    const loginTable = document.getElementById('internLoginTable');
    const interns = users.filter(u => u.role === 'intern');
    
    loginTable.innerHTML = '';
    
    if (interns.length === 0) {
        loginTable.innerHTML = '<tr><td colspan="5" class="text-center">No interns registered yet.</td></tr>';
        return;
    }
    
    interns.forEach(intern => {
        const row = document.createElement('tr');
        const hasCertificate = !!intern.certificate;
        row.innerHTML = `
            <td>${intern.name}</td>
            <td>${intern.email}</td>
            <td>
                <div style="display: flex; align-items: center; gap: 8px;">
                    <span id="password-${intern.id}" style="font-family: monospace; font-size: 14px;">${'*'.repeat(intern.password.length)}</span>
                    <button class="btn btn-outline btn-sm" onclick="togglePasswordVisibility('${intern.id}')" style="padding: 4px 8px; font-size: 12px;">üëÅÔ∏è Show</button>
                    <button class="btn btn-outline btn-sm" onclick="copyPassword('${intern.id}', '${intern.password}')" style="padding: 4px 8px; font-size: 12px;">üìã Copy</button>
                </div>
            </td>
            <td>
                <span class="badge ${hasCertificate ? 'badge-approved' : 'badge-pending'}">${hasCertificate ? 'Active' : 'No Certificate'}</span>
            </td>
            <td>
                <button class="btn btn-primary btn-sm" onclick="openViewInternProfileModal('${intern.id}')">View Details</button>
            </td>
        `;
        loginTable.appendChild(row);
    });
}

// Filter intern login table
function filterInternLoginTable() {
    const searchTerm = document.getElementById('searchInternLogin').value.toLowerCase().trim();
    const rows = document.querySelectorAll('#internLoginTable tr');
    rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length > 0) {
            const name = cells[0].textContent.toLowerCase();
            const email = cells[1].textContent.toLowerCase();
            const matches = name.includes(searchTerm) || email.includes(searchTerm);
            row.style.display = matches ? '' : 'none';
        }
    });
}

// Toggle password visibility
function togglePasswordVisibility(internId) {
    const passwordSpan = document.getElementById(`password-${internId}`);
    const button = event.target;
    const intern = users.find(u => u.id === internId);
    
    if (!intern) return;
    
    if (passwordSpan.textContent.includes('*')) {
        passwordSpan.textContent = intern.password;
        button.textContent = 'üôà Hide';
    } else {
        passwordSpan.textContent = '*'.repeat(intern.password.length);
        button.textContent = 'üëÅÔ∏è Show';
    }
}

// Copy password to clipboard
function copyPassword(internId, password) {
    navigator.clipboard.writeText(password).then(() => {
        showToast('Password copied to clipboard! üìã', 'success');
    }).catch(() => {
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = password;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showToast('Password copied to clipboard! üìã', 'success');
    });
}

// Admin: Prepare Intern History page (select options)
function prepareAdminInternHistory() {
    const select = document.getElementById('selectInternForHistory');
    select.innerHTML = '<option value="">Select intern...</option>';
    users.filter(u=>u.role==='intern').forEach(i=>{
        const opt = document.createElement('option');
        opt.value = i.id;
        opt.textContent = `${i.name} (${i.email})`;
        select.appendChild(opt);
    });
    document.getElementById('adminInternHistoryList').innerHTML = '<div class="card"><p class="text-center">Select an intern to view history.</p></div>';
}

// Render selected intern history
function renderSelectedInternHistory() {
    const internId = document.getElementById('selectInternForHistory').value;
    const container = document.getElementById('adminInternHistoryList');
    container.innerHTML = '';
    if (!internId) {
        container.innerHTML = '<div class="card"><p class="text-center">Select an intern to view history.</p></div>';
        return;
    }
    const intern = users.find(u=>u.id===internId);
    const internSubmissions = submissions.filter(s=>s.userId===internId);
    if (internSubmissions.length===0) {
        container.innerHTML = '<div class="card"><p class="text-center">No submissions for this intern.</p></div>';
        return;
    }
    internSubmissions.sort((a,b)=>new Date(b.createdAt)-new Date(a.createdAt)).forEach(s=>{
        const task = tasks.find(t=>t.id===s.taskId);
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="card-header">
                <div>
                    <h3 class="card-title">${s.title}</h3>
                    <p class="card-meta">üìù ${task?task.title:'Unknown'}</p>
                    <p class="card-meta">üìÖ Submitted: ${new Date(s.createdAt).toLocaleString()}</p>
                </div>
                <span class="badge badge-${s.status}">${s.status}</span>
            </div>
            <p class="card-meta">${s.description || 'No description'}</p>
            ${s.remarks? `<p class="card-meta">üí¨ Remarks: ${s.remarks}</p>` : ''}
            ${s.score? `<p class="card-meta">‚≠ê Score: ${s.score}/${(task?task.maxScore:100)}</p>` : ''}
            <div class="card-actions">
                ${s.files && s.files.length>0? `<button class="btn btn-secondary" onclick="downloadAllFiles('${s.id}')">Download Files</button>`: ''}
                <button class="btn btn-primary" onclick="openReviewModal('${s.id}')">Review</button>
            </div>
        `;
        container.appendChild(card);
    });
}

// view intern Submissions (admin helper)
function viewInternSubmissions(internId) {
    const intern = users.find(u => u.id === internId);
    const internSubmissions = submissions.filter(s => s.userId === internId);
    
    showToast(`${intern.name} has ${internSubmissions.length} submission(s) üìä`, 'success');
    
    document.getElementById('adminSubmissions').scrollIntoView({ behavior: 'smooth' });
}

function deleteIntern(internId) {
    if (confirm('Are you sure you want to delete this intern? This will also delete all their assignments and submissions.')) {
        users = users.filter(u => u.id !== internId);
        assignments = assignments.filter(a => a.internId !== internId);
        submissions = submissions.filter(s => s.userId !== internId);
        saveData();
        showNotification('Intern deleted successfully üóëÔ∏è', 'success');
        refreshInternInfo(internId); // Auto-refresh intern information
        renderAdminDashboard();
    }
}

// Submission Modal
function openSubmissionModal(taskId = null) {
    const modal = document.getElementById('submissionModal');
    const taskSelect = document.getElementById('submissionTask');
    
    taskSelect.innerHTML = '';
    const userAssignments = assignments.filter(a => a.internId === currentUser.id);
    const userTasks = tasks.filter(t => userAssignments.some(a => a.taskId === t.id));

    userTasks.forEach(task => {
        const deadline = new Date(task.deadline);
        const isOpen = deadline > new Date();
        if (isOpen) {
            const option = document.createElement('option');
            option.value = task.id;
            option.textContent = `${task.title} (Deadline: ${deadline.toLocaleDateString()})`;
            taskSelect.appendChild(option);
        }
    });

    if (taskId) {
        taskSelect.value = taskId;
    }

    document.getElementById('submissionForm').reset();
    document.getElementById('submissionId').value = '';
    modal.classList.add('active');
}

function closeSubmissionModal() {
    document.getElementById('submissionModal').classList.remove('active');
}

function editSubmission(submissionId) {
    const submission = submissions.find(s => s.id === submissionId);
    if (!submission) return;

    openSubmissionModal(submission.taskId);
    
    document.getElementById('submissionId').value = submission.id;
    document.getElementById('submissionTitle').value = submission.title;
    document.getElementById('submissionDescription').value = submission.description || '';
    document.getElementById('submissionGithub').value = submission.github || '';
}

async function handleSubmission(event) {
    event.preventDefault();

    const submissionId = document.getElementById('submissionId').value;
    const taskId = document.getElementById('submissionTask').value;
    const title = document.getElementById('submissionTitle').value;
    const description = document.getElementById('submissionDescription').value;
    const github = document.getElementById('submissionGithub').value;
    const filesInput = document.getElementById('submissionFiles');

    const task = tasks.find(t => t.id === taskId);
    if (new Date(task.deadline) < new Date()) {
        showToast('Deadline has passed! ‚è∞', 'error');
        return;
    }

    const files = [];
    if (filesInput.files.length > 0) {
        for (let file of filesInput.files) {
            const dataUrl = await fileToDataUrl(file);
            files.push({
                name: file.name,
                size: file.size,
                type: file.type,
                dataUrl: dataUrl
            });
        }
    }

    if (submissionId) {
        const index = submissions.findIndex(s => s.id === submissionId);
        submissions[index] = {
            ...submissions[index],
            title,
            description,
            github,
            files: files.length > 0 ? files : submissions[index].files,
            status: 'pending',
            updatedAt: new Date().toISOString()
        };
        showToast('Submission updated successfully! ‚ú®', 'success');
    } else {
        const newSubmission = {
            id: generateId(),
            userId: currentUser.id,
            taskId,
            title,
            description,
            github,
            files,
            status: 'pending',
            createdAt: new Date().toISOString()
        };
        submissions.push(newSubmission);
        showToast('Project submitted successfully! üéâ', 'success');
    }

    saveData();
    closeSubmissionModal();
    renderInternDashboard();
}

function deleteSubmission(submissionId) {
    if (confirm('Are you sure you want to delete this submission?')) {
        submissions = submissions.filter(s => s.id !== submissionId);
        saveData();
        showToast('Submission deleted üóëÔ∏è', 'success');
        renderInternDashboard();
    }
}

function viewSubmissionDetails(submissionId) {
    const submission = submissions.find(s => s.id === submissionId);
    const task = tasks.find(t => t.id === submission.taskId);
    
    let details = `Title: ${submission.title}\n`;
    details += `Task: ${task ? task.title : 'Unknown'}\n`;
    details += `Description: ${submission.description || 'No description'}\n`;
    details += `GitHub: ${submission.github || 'Not provided'}\n`;
    details += `Status: ${submission.status}\n`;
    details += `Submitted: ${new Date(submission.createdAt).toLocaleString()}\n`;
    if (submission.score) details += `Score: ${submission.score}\n`;
    if (submission.remarks) details += `Remarks: ${submission.remarks}\n`;
    if (submission.files) details += `Files: ${submission.files.length} file(s)\n`;

    alert(details);
}

function downloadFile(dataUrl, fileName) {
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

async function fileToDataUrl(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
    });
}

// Admin Add Intern Modal
function openAddInternModal() {
    document.getElementById('addInternModal').classList.add('active');
    document.getElementById('addInternForm').reset();
}

function closeAddInternModal() {
    document.getElementById('addInternModal').classList.remove('active');
}

function handleAddIntern(event) {
    event.preventDefault();
    const name = document.getElementById('addInternName').value;
    const email = document.getElementById('addInternEmail').value;
    const password = document.getElementById('addInternPassword').value;

    if (users.find(u => u.email === email)) {
        showToast('Email already in use ‚ùå', 'error');
        return;
    }

    const newIntern = {
        id: generateId(),
        name,
        email,
        password,
        role: 'intern',
        createdAt: new Date().toISOString()
    };

    // Initialize badges for new intern
    newIntern.badges = [];
    users.push(newIntern);
    saveData();
    showNotification('Intern added successfully ‚úÖ', 'success');
    closeAddInternModal();
    refreshInternInfo(newIntern.id); // Auto-refresh intern information
    renderAdminDashboard();
}

// Admin Assign Task Modal
function openAssignTaskModal(internId) {
    const modal = document.getElementById('assignTaskModal');
    const intern = users.find(u => u.id === internId);
    if (!intern) return;

    document.getElementById('assignTaskInternId').value = internId;
    document.getElementById('assignTaskInternName').value = intern.name;

    const taskSelect = document.getElementById('assignTaskSelect');
    taskSelect.innerHTML = '';
    tasks.forEach(task => {
        const option = document.createElement('option');
        option.value = task.id;
        option.textContent = task.title;
        taskSelect.appendChild(option);
    });

    modal.classList.add('active');
}

function closeAssignTaskModal() {
    document.getElementById('assignTaskModal').classList.remove('active');
}

function handleAssignTask(event) {
    event.preventDefault();
    const internId = document.getElementById('assignTaskInternId').value;
    const taskId = document.getElementById('assignTaskSelect').value;

    if (assignments.find(a => a.internId === internId && a.taskId === taskId)) {
        showToast('Task already assigned to this intern ‚ö†Ô∏è', 'warning');
        return;
    }

    const newAssignment = {
        id: generateId(),
        internId,
        taskId,
        assignedAt: new Date().toISOString()
    };

    assignments.push(newAssignment);
    saveData();
    showNotification('Task assigned successfully ‚úÖ', 'success');
    refreshInternInfo(internId); // Auto-refresh intern information
    closeAssignTaskModal();
}

// Admin Task Modal
function openTaskModal() {
    document.getElementById('taskModal').classList.add('active');
    document.getElementById('taskForm').reset();
}

function closeTaskModal() {
    document.getElementById('taskModal').classList.remove('active');
}

function handleAddTask(event) {
    event.preventDefault();
    const title = document.getElementById('taskTitle').value;
    const description = document.getElementById('taskDescription').value;
    const deadline = document.getElementById('taskDeadline').value;
    const maxScore = document.getElementById('taskMaxScore').value;

    const newTask = {
        id: generateId(),
        title,
        description,
        deadline,
        maxScore: parseInt(maxScore),
        createdAt: new Date().toISOString()
    };

    tasks.push(newTask);
    saveData();
    showToast('Assignment created successfully üéØ', 'success');
    closeTaskModal();
    renderAdminDashboard();
}

// Admin Review Modal
function openReviewModal(submissionId) {
    const modal = document.getElementById('reviewModal');
    const submission = submissions.find(s => s.id === submissionId);
    if (!submission) return;

    const user = users.find(u => u.id === submission.userId);
    const task = tasks.find(t => t.id === submission.taskId);

    const reviewContent = document.getElementById('reviewContent');
    reviewContent.innerHTML = `
        <p><strong>Intern:</strong> ${user ? user.name : 'Unknown'}</p>
        <p><strong>Task:</strong> ${task ? task.title : 'Unknown'}</p>
        <p><strong>Submitted:</strong> ${new Date(submission.createdAt).toLocaleString()}</p>
        <p><strong>Title:</strong> ${submission.title}</p>
        <p><strong>Description:</strong> ${submission.description || 'N/A'}</p>
        ${submission.github ? `<p><strong>GitHub:</strong> <a href="${submission.github}" target="_blank" style="color: #667eea; font-weight: 600;">${submission.github}</a></p>` : ''}
        ${submission.files && submission.files.length > 0 ? `
            <div class="file-list">
                <p><strong>Files:</strong></p>
                ${submission.files.map(file => `
                    <div class="file-item">
                        <span>${file.name}</span>
                        <button class="btn btn-outline btn-sm" type="button" onclick="downloadFile('${file.dataUrl}', '${file.name}')">Download</button>
                    </div>
                `).join('')}
            </div>
        ` : '<p>No files submitted.</p>'}
    `;
    
    document.getElementById('reviewSubmissionId').value = submissionId;
    document.getElementById('reviewForm').reset();
    if (submission.score) {
        document.getElementById('reviewScore').value = submission.score;
    }
    if (submission.remarks) {
        document.getElementById('reviewRemarks').value = submission.remarks;
    }
    document.getElementById('reviewScore').max = task ? task.maxScore : 100;
    modal.classList.add('active');
}

function closeReviewModal() {
    document.getElementById('reviewModal').classList.remove('active');
}

function handleReviewAction(action) {
    const submissionId = document.getElementById('reviewSubmissionId').value;
    const remarks = document.getElementById('reviewRemarks').value;
    const scoreInput = document.getElementById('reviewScore');
    const score = scoreInput.value;
    
    const submissionIndex = submissions.findIndex(s => s.id === submissionId);
    if (submissionIndex === -1) return;
    
    const task = tasks.find(t => t.id === submissions[submissionIndex].taskId);
    const maxScore = task ? task.maxScore : 100;

    if (action === 'approved') {
        if (score === '' || parseInt(score) < 0 || parseInt(score) > maxScore) {
            showToast(`Score must be between 0 and ${maxScore} ‚ö†Ô∏è`, 'error');
            return;
        }
         submissions[submissionIndex].score = parseInt(score);
    } else {
         submissions[submissionIndex].score = null;
    }

    submissions[submissionIndex].status = action;
    submissions[submissionIndex].remarks = remarks;
    submissions[submissionIndex].reviewedAt = new Date().toISOString();

    saveData();
    showNotification(`Submission ${action} ‚úÖ`, 'success');
    closeReviewModal();
    
    // Auto-refresh intern information when submission is reviewed
    const submission = submissions[submissionIndex];
    if (submission && submission.userId) {
        refreshInternInfo(submission.userId);
    }
    
    renderAdminDashboard();
    renderAdminSubmissions();
    renderAdminFeedbacks();
}

function deleteSubmissionAdmin(submissionId) {
    if (confirm('Are you sure you want to delete this submission? This is a permanent action.')) {
        submissions = submissions.filter(s => s.id !== submissionId);
        saveData();
        showToast('Submission deleted üóëÔ∏è', 'success');
        renderAdminDashboard();
        renderAdminSubmissions();
    }
}

function downloadAllFiles(submissionId) {
    const submission = submissions.find(s => s.id === submissionId);
    if (submission && submission.files) {
        submission.files.forEach(file => {
            downloadFile(file.dataUrl, file.name);
        });
        showToast('Downloading all files üì•', 'success');
    }
}

// Guideline Modal
function openGuidelineModal() {
    document.getElementById('guidelineModal').classList.add('active');
}

function closeGuidelineModal() {
    document.getElementById('guidelineModal').classList.remove('active');
}

async function handleUploadGuideline(event) {
    event.preventDefault();
    const title = document.getElementById('guidelineTitle').value;
    const fileInput = document.getElementById('guidelineFile');

    if (fileInput.files.length === 0) {
        showToast('Please select a file ‚ö†Ô∏è', 'warning');
        return;
    }

    const file = fileInput.files[0];
    const dataUrl = await fileToDataUrl(file);

    const newGuideline = {
        id: generateId(),
        title,
        fileName: file.name,
        dataUrl,
        createdAt: new Date().toISOString()
    };

    guidelines.push(newGuideline);
    saveData();
    showToast('Guideline uploaded successfully üìö', 'success');

    closeGuidelineModal();
    renderAdminDashboard();
}

// Admin View Intern Profile Modal
function openViewInternProfileModal(internId) {
    const modal = document.getElementById('viewInternProfileModal');
    const intern = users.find(u => u.id === internId);
    if (!intern) return;

    const internSubmissions = submissions.filter(s => s.userId === internId);
    const scores = internSubmissions.filter(s => s.score).map(s => s.score);
    const avgScore = scores.length > 0 ? Math.round(scores.reduce((a, b) => a + b, 0) / scores.length) : 0;

    const profileContent = document.getElementById('internProfileContent');
    profileContent.innerHTML = `
        <h3 class="card-title">${intern.name}</h3>
        <p class="card-meta">üìß ${intern.email}</p>
        <p class="card-meta">üìÖ Joined: ${new Date(intern.createdAt).toLocaleDateString()}</p>
        <div class="score-display">${avgScore}</div>
        <p class="text-center card-meta">Average Score</p>
        <div class="mt-20">
            <p class="card-meta">üìù Total Submissions: ${internSubmissions.length}</p>
        </div>
        <h4 class="mt-20 mb-20" style="color: #667eea;">Submissions</h4>
        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th>Task</th>
                        <th>Status</th>
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody>
                    ${internSubmissions.length > 0 ? internSubmissions.map(s => {
                        const task = tasks.find(t => t.id === s.taskId);
                        return `
                            <tr>
                                <td>${task ? task.title : 'Unknown'}</td>
                                <td><span class="badge badge-${s.status}">${s.status}</span></td>
                                <td>${s.score || 'N/A'}</td>
                            </tr>
                        `;
                    }).join('') : '<tr><td colspan="3" class="text-center">No submissions yet</td></tr>'}
                </tbody>
            </table>
        </div>
        ${intern.certificate ? `
            <div class="mt-20">
                <h4 class="mb-10">Certificate</h4>
                <p class="card-meta">Issued: ${new Date(intern.certificate.issuedAt).toLocaleDateString()}</p>
                <div class="card-actions">
                    <button class="btn btn-primary" onclick="downloadFile('${intern.certificate.dataUrl}', 'certificate-${intern.name.replace(/\\s+/g,'-')}.png')">Download Certificate</button>
                </div>
            </div>
        ` : ''}
    `;

    modal.classList.add('active');
}

function closeViewInternProfileModal() {
    document.getElementById('viewInternProfileModal').classList.remove('active');
}

// SEND CERTIFICATE modal functions
function openSendCertificateModal(internId = '') {
    const modal = document.getElementById('sendCertificateModal');
    const select = document.getElementById('certificateInternSelect');
    select.innerHTML = '';
    users.filter(u=>u.role==='intern').forEach(i=>{
        const opt = document.createElement('option');
        opt.value = i.id;
        opt.textContent = `${i.name} (${i.email})`;
        select.appendChild(opt);
    });
    if (internId) select.value = internId;
    document.getElementById('certificateMessage').value = '';
    document.getElementById('certificateFile').value = '';
    document.getElementById('certificateSource').value = 'upload';
    toggleCertificateSource();
    modal.classList.add('active');
}

function closeSendCertificateModal() {
    document.getElementById('sendCertificateModal').classList.remove('active');
    document.getElementById('sendCertificateForm').reset();
}

function toggleCertificateSource() {
    const source = document.getElementById('certificateSource').value;
    const uploadGroup = document.getElementById('uploadCertificateGroup');
    const generateGroup = document.getElementById('generateCertificateGroup');
    
    if (source === 'upload') {
        uploadGroup.style.display = 'block';
        generateGroup.style.display = 'none';
        document.getElementById('certificateFile').required = true;
        document.getElementById('certificateMessage').required = false;
    } else {
        uploadGroup.style.display = 'none';
        generateGroup.style.display = 'block';
        document.getElementById('certificateFile').required = false;
        document.getElementById('certificateMessage').required = false;
    }
}

/**
 * Simple certificate generator that creates an SVG with the intern's name and message,
 * converts it to a PNG data URL using a canvas, and attaches it to the intern record.
 */
async function generateCertificateDataUrl(name, message) {
    const svg = `
    <svg xmlns="http://www.w3.org/2000/svg" width="1200" height="675">
      <rect width="100%" height="100%" fill="#fff"/>
      <rect x="40" y="40" width="1120" height="595" rx="20" fill="#1e3c72"/>
      <rect x="60" y="60" width="1080" height="555" rx="12" fill="#ffffff"/>
      <text x="600" y="160" font-size="36" text-anchor="middle" fill="#1e3c72" font-family="Arial, sans-serif" font-weight="700">Certificate of Completion</text>
      <text x="600" y="260" font-size="26" text-anchor="middle" fill="#444" font-family="Arial, sans-serif">This certificate is proudly presented to</text>
      <text x="600" y="340" font-size="48" text-anchor="middle" fill="#1e3c72" font-family="Arial, sans-serif" font-weight="800">${escapeHtml(name)}</text>
      <foreignObject x="180" y="380" width="840" height="120">
        <div xmlns="http://www.w3.org/1999/xhtml" style="font-family: Arial, sans-serif; color:#444; font-size:20px; text-align:center;">
          ${escapeHtml(message || '')}
        </div>
      </foreignObject>
      <text x="180" y="560" font-size="18" fill="#666" font-family="Arial, sans-serif">Issued on ${new Date().toLocaleDateString()}</text>
      <text x="1020" y="560" font-size="18" fill="#666" font-family="Arial, sans-serif" text-anchor="end">VeloxCodeAgency</text>
    </svg>
    `;
    // Convert SVG to image and draw to canvas for PNG export
    return new Promise((resolve) => {
        const svgBlob = new Blob([svg], {type: 'image/svg+xml;charset=utf-8'});
        const url = URL.createObjectURL(svgBlob);
        const img = new Image();
        img.onload = () => {
            // canvas to convert
            const canvas = document.createElement('canvas');
            canvas.width = img.width;
            canvas.height = img.height;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = '#fff';
            ctx.fillRect(0,0,canvas.width,canvas.height);
            ctx.drawImage(img,0,0);
            const dataUrl = canvas.toDataURL('image/png');
            URL.revokeObjectURL(url);
            resolve(dataUrl);
        };
        img.onerror = () => {
            URL.revokeObjectURL(url);
            resolve('');
        };
        img.src = url;
    });
}

function escapeHtml(text = '') {
    return String(text)
      .replace(/&/g, '&amp;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;');
}

async function handleSendCertificate(event) {
    event.preventDefault();
    const internId = document.getElementById('certificateInternSelect').value;
    const source = document.getElementById('certificateSource').value;
    
    if (!internId) {
        showToast('Please select an intern ‚ö†Ô∏è', 'warning');
        return;
    }
    
    const internIndex = users.findIndex(u => u.id === internId);
    if (internIndex === -1) {
        showToast('Intern not found ‚ùå', 'error');
        return;
    }
    
    let dataUrl = '';
    let fileName = '';
    let message = '';
    
    if (source === 'upload') {
        const fileInput = document.getElementById('certificateFile');
        if (!fileInput.files || fileInput.files.length === 0) {
            showToast('Please select a certificate file ‚ö†Ô∏è', 'warning');
            return;
        }
        
        const file = fileInput.files[0];
        fileName = file.name;
        showToast('Uploading certificate...', 'success');
        
        // Convert file to data URL
        dataUrl = await fileToDataUrl(file);
        message = 'Certificate uploaded by admin';
    } else {
        message = document.getElementById('certificateMessage').value || '';
        showToast('Generating certificate...', 'success');
        dataUrl = await generateCertificateDataUrl(users[internIndex].name, message);
        fileName = `certificate-${users[internIndex].name.replace(/\s+/g,'-')}.png`;
    }
    
    // Save certificate to intern
    users[internIndex].certificate = {
        dataUrl,
        fileName: fileName || `certificate-${users[internIndex].name.replace(/\s+/g,'-')}.png`,
        issuedAt: new Date().toISOString(),
        message,
        source: source
    };
    
    // Update current user if they're viewing their own profile
    if (currentUser && currentUser.id === internId) {
        currentUser.certificate = users[internIndex].certificate;
    }
    
    saveData();
    closeSendCertificateModal();
    
    // Auto-refresh intern information when certificate is issued
    refreshInternInfo(internId);
    renderAdminCertificates();
    
    // Refresh intern certificate page if they're viewing it
    if (currentUser && currentUser.role === 'intern' && currentUser.id === internId) {
        renderInternCertificate();
    }
    
    showNotification('Certificate issued and attached to intern ‚úÖ', 'success');
    
    // Trigger download
    downloadFile(dataUrl, fileName || `certificate-${users[internIndex].name.replace(/\s+/g,'-')}.png`);
}

// Enhanced Notification System with Email & WhatsApp Integration
let notificationQueue = [];
let isProcessingNotifications = false;

// Notification configuration - UPDATE THESE WITH YOUR DETAILS
const NOTIFICATION_CONFIG = {
    adminEmail: 'admin@veloxcode.com', // Admin email for notifications
    adminWhatsApp: '+1234567890', // Admin WhatsApp number (with country code, no +)
    emailService: 'emailjs', // Using EmailJS (free service)
    emailjsServiceId: 'YOUR_SERVICE_ID', // Get from https://www.emailjs.com
    emailjsTemplateId: 'YOUR_TEMPLATE_ID',
    emailjsPublicKey: 'YOUR_PUBLIC_KEY',
    whatsAppApiUrl: 'https://api.whatsapp.com/send' // WhatsApp web API
};

// Enhanced notification display
function showNotification(message, type = 'success', persistent = false) {
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');

    if (!toast || !toastMessage) {
        console.warn('Toast elements not found');
        return;
    }

    toastMessage.textContent = message;
    toast.className = `toast active toast-${type}`;

    // Request browser notification permission
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }

    // Show browser notification if permitted
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification('VeloxCode Notification', {
            body: message,
            icon: '/favicon.ico',
            tag: 'velox-notification'
        });
    }

    if (!persistent) {
        setTimeout(() => {
            toast.classList.remove('active');
        }, 3000);
    }
}

// Legacy toast function for compatibility
function showToast(message, type = 'success') {
    showNotification(message, type, false);
}

// Send notification via Email using EmailJS
async function sendNotificationToEmail(userEmail, subject, message, type = 'message') {
    try {
        // Check if EmailJS is loaded
        if (typeof emailjs === 'undefined') {
            // Load EmailJS dynamically
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js';
            script.onload = () => {
                emailjs.init(NOTIFICATION_CONFIG.emailjsPublicKey);
                sendEmailNotification(userEmail, subject, message, type);
            };
            document.head.appendChild(script);
            return;
        }

        await sendEmailNotification(userEmail, subject, message, type);
    } catch (error) {
        console.error('Email notification error:', error);
        // Fallback: Use mailto link
        const mailtoLink = `mailto:${NOTIFICATION_CONFIG.adminEmail}?subject=${encodeURIComponent('New ' + type + ': ' + subject)}&body=${encodeURIComponent('From: ' + userEmail + '\n\n' + message)}`;
        window.open(mailtoLink);
    }
}

async function sendEmailNotification(userEmail, subject, message, type) {
    if (typeof emailjs === 'undefined') return;
    
    const templateParams = {
        to_email: NOTIFICATION_CONFIG.adminEmail,
        from_email: userEmail,
        subject: `[${type.toUpperCase()}] ${subject}`,
        message: message,
        type: type,
        timestamp: new Date().toLocaleString()
    };

    await emailjs.send(
        NOTIFICATION_CONFIG.emailjsServiceId,
        NOTIFICATION_CONFIG.emailjsTemplateId,
        templateParams
    );
    
    console.log('Email notification sent successfully');
}

// Send notification via WhatsApp
function sendNotificationToWhatsApp(userEmail, subject, message) {
    try {
        const whatsappNumber = NOTIFICATION_CONFIG.adminWhatsApp.replace(/[^0-9]/g, '');
        const whatsappMessage = encodeURIComponent(
            `üîî New Message from VeloxCode Portal\n\n` +
            `From: ${userEmail}\n` +
            `Subject: ${subject}\n\n` +
            `Message:\n${message}\n\n` +
            `Time: ${new Date().toLocaleString()}`
        );
        
        // Open WhatsApp Web/App with pre-filled message
        const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${whatsappMessage}`;
        
        // Try to open in new tab
        const link = document.createElement('a');
        link.href = whatsappUrl;
        link.target = '_blank';
        link.rel = 'noopener noreferrer';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        console.log('WhatsApp notification initiated');
    } catch (error) {
        console.error('WhatsApp notification error:', error);
    }
}

// Process notification queue
function processNotificationQueue() {
    if (isProcessingNotifications || notificationQueue.length === 0) return;
    
    isProcessingNotifications = true;
    const notification = notificationQueue.shift();
    
    if (notification.type === 'email') {
        sendNotificationToEmail(notification.email, notification.subject, notification.message, notification.messageType);
    } else if (notification.type === 'whatsapp') {
        sendNotificationToWhatsApp(notification.email, notification.subject, notification.message);
    }
    
    isProcessingNotifications = false;
    
    // Process next notification after delay
    if (notificationQueue.length > 0) {
        setTimeout(processNotificationQueue, 1000);
    }
}

// Add notification to queue
function queueNotification(type, email, subject, message, messageType = 'message') {
    notificationQueue.push({ type, email, subject, message, messageType });
    processNotificationQueue();
}

// Kickstart the application
document.addEventListener('DOMContentLoaded', initApp);

    </script>
    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const body = document.body;
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            const overlay = document.getElementById('sidebarOverlay');

                if (window.innerWidth <= 768) {
                const willOpen = !sidebar.classList.contains('mobile-open');
                sidebar.classList.toggle('mobile-open', willOpen);
                sidebar.setAttribute('aria-hidden', willOpen ? 'false' : 'true');
                overlay.classList.toggle('active', willOpen);
                overlay.setAttribute('aria-hidden', willOpen ? 'false' : 'true');
                toggleBtn.classList.toggle('open', willOpen);
                toggleBtn.classList.toggle('active', willOpen);
                toggleBtn.setAttribute('aria-expanded', willOpen ? 'true' : 'false');
                document.body.classList.toggle('sidebar-open', willOpen);

                // Persist mobile preference
                const ui = loadUIState(); ui.sidebarOpenMobile = !!willOpen; saveUIState(ui);

                if (willOpen) {
                    sidebar.setAttribute('tabindex', '-1');
                    sidebar.focus();
                } else {
                    sidebar.removeAttribute('tabindex');
                }
            } else {
                body.classList.toggle('has-sidebar');
                const expanded = body.classList.contains('has-sidebar');
                // Use the same 'open' class so icon animates and turns blue on desktop
                toggleBtn.classList.toggle('open', expanded);
                toggleBtn.classList.toggle('active', expanded);
                toggleBtn.setAttribute('aria-expanded', expanded ? 'true' : 'false');
                // reflect visible state to aria on the sidebar
                sidebar.setAttribute('aria-hidden', expanded ? 'false' : 'true');

                // Persist desktop preference
                const ui = loadUIState(); ui.sidebarOpenDesktop = !!expanded; saveUIState(ui);
            }
        }

        // Helper to close sidebar (mobile overlay or desktop) in a consistent way
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            if (!sidebar || !toggleBtn) return;

            if (window.innerWidth <= 768) {
                // mobile overlay close
                sidebar.classList.remove('mobile-open');
                overlay && overlay.classList.remove('active');
                overlay && overlay.setAttribute('aria-hidden', 'true');
                sidebar.setAttribute('aria-hidden', 'true');
                toggleBtn.classList.remove('open');
                toggleBtn.classList.remove('active');
                toggleBtn.setAttribute('aria-expanded', 'false');
                sidebar.removeAttribute('tabindex');
                document.body.classList.remove('sidebar-open');
            } else {
                // desktop: hide the sidebar
                document.body.classList.remove('has-sidebar');
                sidebar.setAttribute('aria-hidden', 'true');
                toggleBtn.classList.remove('open');
                toggleBtn.classList.remove('active');
                toggleBtn.setAttribute('aria-expanded', 'false');
            }
        }

        // Close mobile sidebar when clicking outside of it
        document.addEventListener('click', function(e) {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            const overlay = document.getElementById('sidebarOverlay');
            if (!sidebar || !toggleBtn || !overlay) return;

            if (window.innerWidth <= 768 && sidebar.classList.contains('mobile-open')) {
                if (!sidebar.contains(e.target) && !toggleBtn.contains(e.target) && !overlay.contains(e.target)) {
                    closeSidebar();
                }
            }
        });

        // Close when clicking overlay
        document.getElementById('sidebarOverlay')?.addEventListener('click', function() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            const overlay = document.getElementById('sidebarOverlay');
            if (!sidebar || !toggleBtn || !overlay) return;
            closeSidebar();

            // Also restore desktop default after closing on small screens
            if (window.innerWidth > 768) {
                document.body.classList.add('has-sidebar');
                toggleBtn.classList.toggle('open', true);
                toggleBtn.setAttribute('aria-expanded', 'true');
            }
        });

        // Close sidebar when any navigation option is clicked
        document.getElementById('sidebarNav')?.addEventListener('click', function(e) {
            const navBtn = e.target.closest('.nav-btn');
            if (navBtn) {
                // allow click handler (showPage/logout) to run first
                setTimeout(() => {
                    if (typeof closeSidebar === 'function') closeSidebar();
                }, 10);
            }
        });

        // Reset mobile state on resize (so sidebar doesn't stay open when switching sizes)
        window.addEventListener('resize', function() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('sidebarToggleBtn');
            const overlay = document.getElementById('sidebarOverlay');
            if (!sidebar || !toggleBtn || !overlay) return;

            if (window.innerWidth > 768) {
                // Close any mobile-specific states
                closeSidebar();

                // Ensure desktop shows the sidebar by default
                document.body.classList.add('has-sidebar');
                toggleBtn.classList.toggle('open', true);
                toggleBtn.setAttribute('aria-expanded', 'true');
            }
        });
    </script>
</body>
</html>